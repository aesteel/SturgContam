---
title: "Exposure_Analysis3 - Model Selection"
author: "Anna Steel"
date: "9/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readtext) # need this because the ethovision output .txt files have unusual encoding as UTF-16
library(lme4)
library(rethinking)
library(rprojroot) # only used for find_rstudio_root_file() to set project wd as root
library(patchwork)

knitr::opts_knit$set(root.dir = find_rstudio_root_file()) # sets root directory to match project directory, not rmd file location
```

```{r utility functions, include=FALSE}
# calculate hypotenuse of triangle created by two xy locations

distmov = function(x1,x2,y1,y2) { dm = sqrt((x1-x2)^2 + (y1-y2)^2); return(dm)}

# calculate number steps between detections; use summarized dataset (5 pos/sec)
nstep = function(t2,t1, interv=0.2) {
  if (t2-t1 < 0) stop('time steps backwards?')
  nstep <- ( (t2-t1) / interv)
  return(nstep)
  }

```


## Read in Cleaned Data ("Exposure_Analysis1.Rmd")
```{r read in clean data}
DataSum2496 = read.csv("outputData/Exposure_Outputdata/Bifenthrin_2020_Cleaned_FullData.csv")
```




## Statistical Models, predictions, and other posterior queries for each metric (Total distance travelled, Mean velocity, Meander and Turn angle, Use of center zone (% time), Time Active, Full Rotations vs distance traveled) 


### Distance Models
```{r distance data, echo=F}

## Summarize to take total distance (sum moved in a trial) for each fish replicates
DataSum2496.dist = DataSum2496 %>%
  group_by(index, Trial, Arena, Replicate, ExposureHrs, Treatment, calcConc, Spp, RepID) %>%
  summarize(TotalfishDist_m = sum(SumDistMoved, na.rm=T)/(10*100)) %>%
  ungroup()  %>%
  
  mutate(lnCalcConc = log(calcConc+1)) %>%
  mutate(lnCalcConcC= scale(lnCalcConc, scale=FALSE)) %>%
  mutate(lnCalcConcC2 = lnCalcConcC^2 ) %>% 
   # order of transformations matters (log then scale then square)

  mutate(ExposureHrsC = scale(ExposureHrs, scale=FALSE)) %>%
  data.frame()

MeanDist0 = DataSum2496.dist %>%
  subset(Treatment==0) %>%
  group_by(Spp, ExposureHrs) %>%
  summarize(mean0_dist = mean(TotalfishDist_m)) %>%
  ungroup()  %>%
  # mutate(lnCalcConcC= scale(lnCalcConc, scale=FALSE)) %>%
  # mutate(lnCalcConcC2 = lnCalcConcC^2) %>%
  data.frame()

DataSumDiff.dist = merge(DataSum2496.dist, MeanDist0, all.x=T)
DataSumDiff.dist$DistDiff = DataSumDiff.dist$TotalfishDist_m - DataSumDiff.dist$mean0_dist


```

```{r distance freqmodels total, echo=F, eval=F}
qqnorm((DataSum2496.dist$TotalfishDist)); qqline((DataSum2496.dist$TotalfishDist))
qqnorm(log(DataSum2496.dist$TotalfishDist)); qqline(log(DataSum2496.dist$TotalfishDist))

DataSum2496.dist$Spp = factor(DataSum2496.dist$Spp)
DataSum2496.dist$lnCalcConc = log(DataSum2496.dist$calcConc+0.1)

# create dataframe with centered variables: see https://stats.stackexchange.com/questions/29781/when-conducting-multiple-regression-when-should-you-center-your-predictor-varia with discussion of how collinearity is induced with quadratic terms or interactions if variables are not centered first (no mention of standardizing variance though). 

DS.dist.moddat = DataSum2496.dist
 DS.dist.moddat$ExposureHrs.c = scale(DS.dist.moddat$ExposureHrs, center=TRUE, scale=FALSE) # scaled center = 61.2
 DS.dist.moddat$lnCalcConc.c = scale(DS.dist.moddat$lnCalcConc, center=TRUE, scale=FALSE) # scaled center = 3.73

# fit models, including non-complete sets of replicate videos (WS-4)
dist.lm = lmer(TotalfishDist ~ Spp*lnCalcConc + ExposureHrs*lnCalcConc + (1|RepID), data = DS.dist.moddat)
 
 ggplot(data = data.frame(Deviance.Residuals = residuals(dist.lm), Fitted = fitted(dist.lm)), 
        aes(x=Fitted, y=Deviance.Residuals)) + 
   geom_point(color='steelblue3', pch=21, size=3) + 
   geom_smooth() + 
   theme_bw()
 
 qqnorm(residuals(dist.lm)); qqline(residuals(dist.lm))
 # plots show slight bend in residual plot; but residuals mostly normally distributed
 
 
# fit models, add quadratic to account for curved relationship in data and residual plopt
dist.lm2 = lmer(TotalfishDist ~ Spp*lnCalcConc.c + Spp*(I(lnCalcConc.c^2))+ ExposureHrs.c*lnCalcConc.c + (1|RepID), data = DS.dist.moddat)
 
ggplot(data = data.frame(Deviance.Residuals = residuals(dist.lm2), Fitted = fitted(dist.lm2)), 
        aes(x=Fitted, y=Deviance.Residuals)) + 
   geom_point(color='steelblue3', pch=21, size=3) + 
   geom_smooth() + 
   theme_bw()
 
 qqnorm(residuals(dist.lm2)); qqline(residuals(dist.lm2))
 # residual plots look better

 
 dist.lm3 = lmer(TotalfishDist ~ Spp*lnCalcConc.c + Spp*(I(lnCalcConc.c^2))+ ExposureHrs.c + (1|RepID), data = DS.dist.moddat)
 
ggplot(data = data.frame(Deviance.Residuals = residuals(dist.lm3), Fitted = fitted(dist.lm3)), 
        aes(x=Fitted, y=Deviance.Residuals)) + 
   geom_point(color='steelblue3', pch=21, size=3) + 
   geom_smooth() + 
   theme_bw()
 
 qqnorm(residuals(dist.lm3)); qqline(residuals(dist.lm3))
 
 
AIC(dist.lm2, dist.lm3)

summary(dist.lm3)
``` 

```{r distance freqmodels predict, echo=F, eval=F}
preddat.lm2.dist = expand.grid(Spp= c("GS","WS"), lnCalcConc.c = seq(-6.1,4, .1), ExposureHrs.c = unique(DS.dist.moddat$ExposureHrs.c))#, RepID = "0-GS-9")

preddat.lm2.dist$fit  = predict(dist.lm2, newdata = preddat.lm3.dist, re.form=~0)#, allow.new.levels=TRUE)

ggplot(preddat.lm2.dist, aes(x=lnCalcConc.c, y=fit/10)) + 
  geom_line() + 
  facet_grid(Spp~ExposureHrs.c, labeller = labeller(
                      Spp = c("GS"="Green Sturgeon","WS"="White Sturgeon"),
                      ExposureHrs.c = c("-37.1612903225806" = "24 hrs", "34.8387096774194"="96 hrs") ) ) +
  geom_point(data=DS.dist.moddat, 
             aes(y=TotalfishDist/10, x=scale(lnCalcConc, scale=FALSE), fill=factor(Treatment) ),
             alpha=.6, pch=21, color="grey20") + 
  xlab("Log(Bifenthrin Concentration") +
  ylab("Total Trial Distance (cm)") + 
  scale_fill_viridis_d(name="Nominal Bifenthrin\nConcentration (ng/L)") +
  theme_bw()

```
#### neither the raw values of distance nor the log transformed values are particularly normal
#### frequentist exploratory models do fine highlighting the need for a quadratic term for concentration, and the lack of a need for an interaction between concentration and exposure hours


```{r distance single level Bayesmodels, echo=F, eval=F}
# try setting up the linear model in a bayesian form, same as frequentist model above

DSdist_bmoddat = DataSum2496.dist[,c("TotalfishDist_m","lnCalcConcC","lnCalcConcC2",
                                     "ExposureHrs","Spp","RepID")]
#DSdist_bmoddat$TotalfishDistcm = DSdist_bmoddat$TotalfishDist/10
DSdist_bmoddat$lnCalcConcC = as.numeric(DSdist_bmoddat$lnCalcConcC) 
DSdist_bmoddat$lnCalcConcC2 = as.numeric(DSdist_bmoddat$lnCalcConcC2) 
DSdist_bmoddat$SppDummy <- ifelse(DSdist_bmoddat$Spp=="GS", 0,1)
DSdist_bmoddat$ExposeDummy <- ifelse(DSdist_bmoddat$ExposureHrs=="24", 0,1)

distspp.blm_add = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
    mu  <- a + bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + bs*SppDummy + be*ExposeDummy,
        a ~ dnorm(10,10),
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        be ~ dnorm(0,10),
      sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


distspp.blm_int1 = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
    mu  <- a + bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + bs*SppDummy + be*ExposeDummy + 
      bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2),
       a ~ dnorm(10,10),
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        be ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


distspp.blm_int2 = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
   mu  <- a + bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + bs*SppDummy + be*ExposeDummy + 
      bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2) + 
      bte1*(ExposeDummy)*(lnCalcConcC) + bte2*(ExposeDummy)*(lnCalcConcC2),
        a ~ dnorm(10,10),
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        be ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
        bte1 ~ dnorm(0,10),
        bte2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


distspp.blm_int3 = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
   mu  <- a + bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + bs*SppDummy + be*ExposeDummy + 
      bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2) + 
      btes1*(ExposeDummy)*(lnCalcConcC)*(SppDummy) + btes2*(ExposeDummy)*(lnCalcConcC2)*(SppDummy),
        a ~ dnorm(10,10),
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        be ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
        btes1 ~ dnorm(0,10),
        btes2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


distspp.blm_int4 = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
   mu  <- a + bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + bs*SppDummy + 
              be*ExposeDummy + bse*(SppDummy)*(ExposeDummy),
        a ~ dnorm(10,10),
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        be ~ dnorm(0,10),
        bse ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


distspp.blm_int5 = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
   mu  <- a + bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + bs*SppDummy + 
              be*ExposeDummy + bse*(SppDummy)*(ExposeDummy) +
              bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2),
        a ~ dnorm(10,10),
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        be ~ dnorm(0,10),
        bse ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


 plot(distspp.blm_int1)
 plot(distspp.blm_int2)
 plot(distspp.blm_int3)
 plot(distspp.blm_int4)
 
 precis(distspp.blm_int1, prob = .95, digits=3)
 precis(distspp.blm_int2, prob = .95, digits=3)
 precis(distspp.blm_int3, prob = .95, digits=3)
 precis(distspp.blm_int4, prob = .95, digits=3)

 plot(precis(distspp.blm_int1, prob = .95))
 plot(precis(distspp.blm_int2, prob = .95))
 plot(precis(distspp.blm_int3, prob = .95))
 plot(precis(distspp.blm_int4, prob = .95))
 
compare(distspp.blm_add, distspp.blm_int1, distspp.blm_int2, distspp.blm_int3, distspp.blm_int4)
plot(compare(distspp.blm_add, distspp.blm_int1, distspp.blm_int2, distspp.blm_int3, distspp.blm_int4))
plot(compare(distspp.blm_int1, distspp.blm_int4)) 
### models 1 and 4 are reasonable, rest are much much worse. The raw data and thre biology suggest model 4 is the best, because WS reduce movement as they age and GS increase movement as they age. So the effect of Exposure Hour should interact with species. 
```

```{r distance single level Bayesmodels predict, echo=F, eval=F}
# set up dataframe to plot posterior predictions
preddat.base = expand.grid(CalcConc=(seq(0, 2250, .5)), ExposeDummy = c(0,1), SppDummy = c(0,1))

preddat = preddat.base %>%
 mutate(lnCalcConc = log(CalcConc+1)) %>%
  mutate(lnCalcConcC= lnCalcConc - mean(DataSum2496.dist$lnCalcConc))  %>%
  mutate(lnCalcConcC2 = lnCalcConcC^2 ) %>% 
  data.frame()

# predict from posteriors (on transformed scale)
  link_pred <- link(distspp.blm_int4, data = preddat, n=1000) 
  preddat$link_mu_mn <- apply(link_pred, 2, mean)
  preddat$link_PI05 = apply(link_pred, 2, PI, .95)[1,]
  preddat$link_PI95 = apply(link_pred, 2, PI, .95)[2,]
  
 # predict with sim; it's my understanding that this integrates the error estimates too?
  sim_pred <- sim(distspp.blm_int1, data = preddat, n=1000) 
  preddat$sim_mu_mn <- apply(sim_pred, 2, mean)
  preddat$sim_PI05 = apply(sim_pred, 2, PI, .95)[1,]
  preddat$sim_PI95 = apply(sim_pred, 2, PI, .95)[2,]
 
  # plot back-transformed data
  preddat$Spp <- ifelse(preddat$SppDummy==0,"GS","WS")
  preddat$ExposureHrs <- ifelse(preddat$ExposeDummy==0,"24","96")


DistPred_transf_plot = ggplot() + 
  geom_point(data=DataSum2496.dist,
             aes(x=(lnCalcConcC),                          
                 y=TotalfishDist_m, 
                 color=factor(Spp))) + 
  geom_ribbon(data = preddat, aes(x=(lnCalcConcC), 
              ymin=link_PI05, ymax=link_PI95), 
              alpha=.4, col="grey70")+
   geom_line(data = preddat, aes(x=(lnCalcConcC), y=link_mu_mn), lwd=.2)+
  facet_grid(Spp~ExposureHrs, scales="free", labeller = labeller(
    ExposureHrs = c("24"="24 Hours Exposure","96"="96 Hours Exposure"),
    Spp = c("GS" = "Green Sturgeon", "WS" = "White Sturgeon")))+
  scale_color_manual(values=c("green3", "steelblue3"), guide=FALSE)+
  ylab("Total Distance Traveled (m)") + 
  scale_x_continuous(name="Bifenthrin Concentration (ng/L)") + #, breaks = seq(-7.5,5, 2.5), labels=(seq(-7.5,5, 2.5)+3.73) ) +
  theme_bw()


DistPred_orig_plot = ggplot() + 
  geom_point(data=DataSum2496.dist,
             aes(x=(calcConc),                          
                 y=TotalfishDist_m, 
                 color=factor(Spp))) + 
  geom_ribbon(data = preddat, aes(x=(CalcConc), 
              ymin=link_PI05, ymax=link_PI95), 
              alpha=.4, col="grey70")+
  geom_line(data = preddat, aes(x=(CalcConc), y=link_mu_mn), lwd=.2)+
  facet_grid(Spp~ExposureHrs, scales="free", labeller = labeller(
    ExposureHrs = c("24"="24 Hours Exposure","96"="96 Hours Exposure"),
    Spp = c("GS" = "Green Sturgeon", "WS" = "White Sturgeon")))+
  scale_color_manual(values=c("green3", "steelblue3"), guide=FALSE)+
  ylab("Total Distance Traveled (cm)") + 
  scale_x_continuous(name="Bifenthrin Concentration (ng/L)") + #, breaks = seq(-7.5,5, 2.5), labels=(seq(-7.5,5, 2.5)+3.73) ) +
  theme_bw()


```
#### quadratic is critical, and interaction of spp*conc (both straight and quadratic) seems to allow a better species-specific curve. But trying this plot with the additional interactions in ...int2 and ...int3 doesn't visually improve fit. When we plot on the original concentration scale (versus the cetnered-log scale the modeling is done with) we get a nice curve for all but the WS-24hr. It's possible that a quadratic term is just too simple of a shape to capture the shift in moderate doses over time?
  
    
### Contrasts
  
### Study questions: 
###  1) is there an effect (all treatment vs control), and which metrics show an effect
###  2) does that effect change with time [96 treat vs 96 control and 24 treat vs 24 control OR individual change from 24 to 96 (all treatments) as compared to individual change for control between 24 and 96]
###  3) Does the magnitude of the effect vary between species

```{r distance single level model contrasts, echo=F, eval=F}
# pull posterior (distn of parameter estimates)
postdist = extract.samples(distspp.blm_int1)

      # # calculate effect of treatment, for each species, at 24hrs
      # gamma.24GS = postdist$bt + postdist$bt2 
      # gamma.24WS = postdist$bt + postdist$bt2 + postdist$bts1 + postdist$bts2 # (sppdummy=1 for WS)
      # # calculate effect of treatment, for each species, at 96hrs (exposedummy=1 for 96hrs)
      # gamma.96GS = postdist$bt + postdist$bt2 + postdist$be
      # gamma.96WS = postdist$bt + postdist$bt2 + + postdist$bts1 + postdist$bts2 + postdist$be
      # 
      # # Can calc mean effect, as in rethinking textbook example for interactions, but less meaningful because it's a quadratic, so the effect changes given the treatment value
      # ## see page 236 from rethinking 2015 
      # mean(gamma.24GS)
      # mean(gamma.24WS)
      # mean(gamma.96GS)
      # mean(gamma.96WS)
      # 
      # dens(gamma.24GS, xlab="quadratic interaction", col="green3", xlim=c(-400,0))
      # dens(gamma.24WS, add=TRUE, col="steelblue3")
      # dens(gamma.96GS, add=TRUE, col="darkblue")
      # dens(gamma.96WS, add=TRUE, col="darkgreen")

# reference table to convert from treatment to centered, log-transformed measured concentrations
TreatCalcTable = unique(DataSum2496.dist[order(DataSum2496.dist$Treatment)
                                             ,c("Spp", "Treatment","lnCalcConc", "lnCalcConcC")])

TreatCalcTable$lnCalcConcC2 = TreatCalcTable$lnCalcConcC ^ 2


# calculate differences between control and treatment at each time point for each species (20 contrasts)
GS0bif24 = postdist$a
GS5bif24 = postdist$a + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==5)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==5)$lnCalcConcC2)
GS100bif24 = postdist$a + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==100)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==100)$lnCalcConcC2)
GS500bif24 = postdist$a + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==500)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==500)$lnCalcConcC2)
GS1000bif24 = postdist$a +
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==1000)$lnCalcConcC) + 
  postdist$bt2* as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==1000)$lnCalcConcC2)
GS2000bif24 = postdist$a + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==2000)$lnCalcConcC) + 
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==2000)$lnCalcConcC2)

mean(GS0bif24)
mean(GS5bif24)
mean(GS100bif24)
mean(GS500bif24)
mean(GS1000bif24)
mean(GS2000bif24)


GS24.plot = ggplot() + geom_density(aes(x=GS0bif24), color="black") + 
  geom_density(aes(x=GS5bif24), color="green3") + 
  geom_density(aes(x=GS100bif24), color="goldenrod") + 
  geom_density(aes(x=GS500bif24), color="red3") + 
  geom_density(aes(x=GS1000bif24), color="pink") + 
  geom_density(aes(x=GS2000bif24), color="steelblue3") + 
  xlab("Distance moved (GS @ 24hr)")+
  theme_bw()
 

GS0bif96 = postdist$a + postdist$be
GS5bif96 = postdist$a + postdist$be + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==5)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==5)$lnCalcConcC2)
GS100bif96 = postdist$a + postdist$be + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==100)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==100)$lnCalcConcC2)
GS500bif96 = postdist$a + postdist$be + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==500)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==500)$lnCalcConcC2)
GS1000bif96 = postdist$a + postdist$be +
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==1000)$lnCalcConcC) + 
  postdist$bt2* as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==1000)$lnCalcConcC2)
GS2000bif96 = postdist$a + postdist$be + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==2000)$lnCalcConcC) + 
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="GS" & Treatment==2000)$lnCalcConcC2)

mean(GS0bif96)
mean(GS5bif96)
mean(GS100bif96)
mean(GS500bif96)
mean(GS1000bif96)
mean(GS2000bif96)

GS96.plot = ggplot() + geom_density(aes(x=GS0bif96), color="black") + 
  geom_density(aes(x=GS5bif96), color="green3") + 
  geom_density(aes(x=GS100bif96), color="goldenrod") + 
  geom_density(aes(x=GS500bif96), color="red3") + 
  geom_density(aes(x=GS1000bif96), color="pink") + 
  geom_density(aes(x=GS2000bif96), color="steelblue3") + 
  xlab("Distance moved (GS @ 96hr)")+
  theme_bw()
 

# repeat for white sturgeon

WS0bif24 = postdist$a + postdist$bs
WS5bif24 = postdist$a + postdist$bs + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==5)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==5)$lnCalcConcC2)
WS100bif24 = postdist$a + postdist$bs + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==100)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==100)$lnCalcConcC2)
WS500bif24 = postdist$a + postdist$bs + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==500)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==500)$lnCalcConcC2)
WS1000bif24 = postdist$a + postdist$bs +
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==1000)$lnCalcConcC) + 
  postdist$bt2* as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==1000)$lnCalcConcC2)
WS2000bif24 = postdist$a + postdist$bs + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==2000)$lnCalcConcC) + 
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==2000)$lnCalcConcC2)

mean(WS0bif24)
mean(WS5bif24)
mean(WS100bif24)
mean(WS500bif24)
mean(WS1000bif24)
mean(WS2000bif24)

WS24.plot = ggplot() + geom_density(aes(x=WS0bif24), color="black") + 
  geom_density(aes(x=WS5bif24), color="green3") + 
  geom_density(aes(x=WS100bif24), color="goldenrod") + 
  geom_density(aes(x=WS500bif24), color="red3") + 
  geom_density(aes(x=WS1000bif24), color="pink") + 
  geom_density(aes(x=WS2000bif24), color="steelblue3") + 
  xlab("Distance moved (WS @ 24hr)")+
  theme_bw()
 

WS0bif96 = postdist$a + postdist$bs + postdist$be
WS5bif96 = postdist$a + postdist$bs + postdist$be + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==5)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==5)$lnCalcConcC2)
WS100bif96 = postdist$a + postdist$bs + postdist$be + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==100)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==100)$lnCalcConcC2)
WS500bif96 = postdist$a + postdist$bs + postdist$be + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==500)$lnCalcConcC) +
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==500)$lnCalcConcC2)
WS1000bif96 = postdist$a + postdist$bs + postdist$be +
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==1000)$lnCalcConcC) + 
  postdist$bt2* as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==1000)$lnCalcConcC2)
WS2000bif96 = postdist$a + postdist$bs + postdist$be + 
  postdist$bt*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==2000)$lnCalcConcC) + 
  postdist$bt2*as.numeric(subset(TreatCalcTable, Spp=="WS" & Treatment==2000)$lnCalcConcC2)


mean(WS0bif96)
mean(WS5bif96)
mean(WS100bif96)
mean(WS500bif96)
mean(WS1000bif96)
mean(WS2000bif96)


WS96.plot = ggplot() + geom_density(aes(x=WS0bif96), color="black") + 
  geom_density(aes(x=WS5bif96), color="green3") + 
  geom_density(aes(x=WS100bif96), color="goldenrod") + 
  geom_density(aes(x=WS500bif96), color="red3") + 
  geom_density(aes(x=WS1000bif96), color="pink") + 
  geom_density(aes(x=WS2000bif96), color="steelblue3") + 
  xlab("Distance moved (WS @ 96hr)")+
  theme_bw()


GS24.plot
GS96.plot
WS24.plot
WS96.plot
```
```{r distance single level model time contrasts, echo=F, eval=F}
# is this right?
cont.GS0bif_96.24 = (sum(GS0bif96<GS0bif24) / length(GS0bif96))
cont.GS5bif_96.24 = (sum(GS5bif96<GS5bif24) / length(GS5bif96))
cont.GS100bif_96.24 = (sum(GS100bif96<GS100bif24) / length(GS100bif96))
cont.GS500bif_96.24 = (sum(GS500bif96<GS500bif24) / length(GS500bif96))
cont.GS1000bif_96.24 = (sum(GS1000bif96<GS1000bif24) / length(GS1000bif96))
cont.GS2000bif_96.24 = (sum(GS2000bif96<GS2000bif24) / length(GS2000bif96))


GS0bif_96.24.plot = ggplot() + geom_density(aes(x=GS0bif96), color="steelblue3") + 
  geom_density(aes(x=GS0bif24), color="green3") + 
  xlab("Distance moved - GS @ 0 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS5bif_96.24.plot = ggplot() + geom_density(aes(x=GS5bif96), color="steelblue3") + 
  geom_density(aes(x=GS5bif24), color="green3") + 
  xlab("Distance moved - GS @ 5 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS100bif_96.24.plot = ggplot() + geom_density(aes(x=GS100bif96), color="steelblue3") + 
  geom_density(aes(x=GS100bif24), color="green3") + 
  xlab("Distance moved - GS @ 100 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS500bif_96.24.plot = ggplot() + geom_density(aes(x=GS500bif96), color="steelblue3") + 
  geom_density(aes(x=GS500bif24), color="green3") + 
  xlab("Distance moved - GS @ 500 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS1000bif_96.24.plot = ggplot() + geom_density(aes(x=GS1000bif96), color="steelblue3") + 
  geom_density(aes(x=GS1000bif24), color="green3") + 
  xlab("Distance moved - GS @ 1000 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS2000bif_96.24.plot = ggplot() + geom_density(aes(x=GS2000bif96), color="steelblue3") + 
  geom_density(aes(x=GS2000bif24), color="green3") + 
  xlab("Distance moved - GS @ 2000 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()


# use patchwork grammar to plot multiple plots
(GS0bif_96.24.plot|GS5bif_96.24.plot|GS100bif_96.24.plot)/(GS500bif_96.24.plot|GS1000bif_96.24.plot|GS2000bif_96.24.plot)

cont.GS0bif_96.24
cont.GS5bif_96.24
cont.GS100bif_96.24
cont.GS500bif_96.24
cont.GS1000bif_96.24
cont.GS2000bif_96.24

```
# well, these plots look somewhat different but not super different; and they all look about the same different (as they should since there's no interaction for concentration * exposure time); which fits the contrast ## of 97.5% likely (for all comparisons, because there isn't an interaction) that the distance moved at 96 is less than the distance moved at 24  
  
  # check with Zack before getting much farther. And think carefully about how I want to present these numbers so my work is towards a goal and not in a useless circle. Maybe write the results section with XX and YY placeholders?   
     
```{r distance model conc contrasts, echo=F}
# is this right?
cont.GS5bif_96 = (sum(GS5bif96<GS0bif96) / length(GS5bif96))
cont.GS100bif_96.24 = (sum(GS100bif96<GS0bif24) / length(GS100bif96))
cont.GS500bif_96.24 = (sum(GS500bif96<GS0bif24) / length(GS500bif96))
cont.GS1000bif_96.24 = (sum(GS1000bif96<GS0bif24) / length(GS1000bif96))
cont.GS2000bif_96.24 = (sum(GS2000bif96<GS0bif24) / length(GS2000bif96))


GS0bif_96.24.plot = ggplot() + geom_density(aes(x=GS0bif96), color="steelblue3") + 
  geom_density(aes(x=GS0bif24), color="green3") + 
  xlab("Distance moved - GS @ 0 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS5bif_96.24.plot = ggplot() + geom_density(aes(x=GS5bif96), color="steelblue3") + 
  geom_density(aes(x=GS5bif24), color="green3") + 
  xlab("Distance moved - GS @ 5 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS100bif_96.24.plot = ggplot() + geom_density(aes(x=GS100bif96), color="steelblue3") + 
  geom_density(aes(x=GS100bif24), color="green3") + 
  xlab("Distance moved - GS @ 100 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS500bif_96.24.plot = ggplot() + geom_density(aes(x=GS500bif96), color="steelblue3") + 
  geom_density(aes(x=GS500bif24), color="green3") + 
  xlab("Distance moved - GS @ 500 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS1000bif_96.24.plot = ggplot() + geom_density(aes(x=GS1000bif96), color="steelblue3") + 
  geom_density(aes(x=GS1000bif24), color="green3") + 
  xlab("Distance moved - GS @ 1000 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()
GS2000bif_96.24.plot = ggplot() + geom_density(aes(x=GS2000bif96), color="steelblue3") + 
  geom_density(aes(x=GS2000bif24), color="green3") + 
  xlab("Distance moved - GS @ 2000 ng/L bifenthrin\n24 vs 96 hrs)") +
  theme_bw()


# use patchwork grammar to plot multiple plots
(GS0bif_96.24.plot|GS5bif_96.24.plot|GS100bif_96.24.plot)/(GS500bif_96.24.plot|GS1000bif_96.24.plot|GS2000bif_96.24.plot)

cont.GS0bif_96.24
cont.GS5bif_96.24
cont.GS100bif_96.24
cont.GS500bif_96.24
cont.GS1000bif_96.24
cont.GS2000bif_96.24

```     
     

```{r distance multi-level Bayesmodels, echo=F}
# try setting up the linear model in a bayesian form, same as frequentist model above

DSdist_bmoddat = DataSum2496.dist[,c("TotalfishDist_m","lnCalcConcC","lnCalcConcC2",
                                     "ExposureHrs","Spp","RepID")]
#DSdist_bmoddat$TotalfishDistcm = DSdist_bmoddat$TotalfishDist/10
DSdist_bmoddat$lnCalcConcC = as.numeric(DSdist_bmoddat$lnCalcConcC) 
DSdist_bmoddat$lnCalcConcC2 = as.numeric(DSdist_bmoddat$lnCalcConcC2) 
DSdist_bmoddat$SppDummy <- ifelse(DSdist_bmoddat$Spp=="GS", 0,1)
DSdist_bmoddat$ExposeDummy <- ifelse(DSdist_bmoddat$ExposureHrs=="24", 0,1)

# remove fish with only one timepoint of detection, because cant add random slope with one timepoint
DSdist_bmoddat = DSdist_bmoddat[!(DSdist_bmoddat$RepID %in% paste0(c(0,5,100,500,1000,2000), "-WS-4")),]


distspp.blm_int1.rise = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
     mu  <- a_fish[RepID] + 
             bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + 
             be_fish[RepID]*ExposeDummy + 
             bs*SppDummy + 
             bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2),
        # Wrong way of extending a random intercept; doesn't include correlation between slope and intercept for the same individual
        # a_fish[RepID] ~ dnorm(a,a_sig),
        #   a ~ dcauchy(0,10),
        #   a_sig ~ dcauchy(0,10),
        # be_fish[RepID] ~ dnorm(be,be_sig),
        #   be ~ dcauchy(0,10),
        #   be_sig ~ dcauchy(0,10),
        # Right way, because includes correlation by individual
           c(a_fish,be_fish)[RepID] ~ dmvnorm2(Mu=c(a,be), sigma=sigma_fish, Rho=Rho),
           a ~ dnorm(0,10),
           be ~ dnorm(0,10),
           sigma_fish ~ dcauchy(0,10),
           Rho ~ dlkjcorr(2),
             # not as flat as (1) but biases against strong correlations of intercept and slope
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)

precis(distspp.blm_int1)
precis(distspp.blm_int1.rise)

plot(distspp.blm_int1)
plot(distspp.blm_int1.rise)

compare(distspp.blm_int1.rise, distspp.blm_int1)

# the precis values don't look THAT different. 


distspp.blm_int2.rise = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
    mu  <- a_fish[RepID] + 
             bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + 
             be_fish[RepID]*ExposeDummy + 
             bs*SppDummy + 
             bse*(SppDummy)*(ExposeDummy) +
             bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2) +
             bte1*(ExposeDummy)*(lnCalcConcC) + bte2*(ExposeDummy)*(lnCalcConcC2),
         # does the interaction also need to have the random effect? I hope not =/
           c(a_fish,be_fish)[RepID] ~ dmvnorm2(Mu=c(a,be), sigma=sigma_fish, Rho=Rho),
           a ~ dnorm(0,10),
           be ~ dnorm(0,10),
           sigma_fish ~ dcauchy(0,10),
           Rho ~ dlkjcorr(2),
             # not as flat as (1) but biases against strong correlations of intercept and slope
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        bse ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
        bte1 ~ dnorm(0,10),
        bte2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


distspp.blm_int5.rise = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
    mu  <- a_fish[RepID] + 
             bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + 
             be_fish[RepID]*ExposeDummy + 
             bs*SppDummy + 
             bse*(SppDummy)*(ExposeDummy) +
             bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2),
         # does the interaction also need to have the random effect? I hope not =/
           c(a_fish,be_fish)[RepID] ~ dmvnorm2(Mu=c(a,be), sigma=sigma_fish, Rho=Rho),
           a ~ dnorm(0,10),
           be ~ dnorm(0,10),
           sigma_fish ~ dcauchy(0,10),
           Rho ~ dlkjcorr(2),
             # not as flat as (1) but biases against strong correlations of intercept and slope
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        bse ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


 plot(distspp.blm_int1.rise)
 plot(distspp.blm_int2.rise)
 plot(distspp.blm_int5.rise)
 
 precis(distspp.blm_int1.rise, prob = .95, digits=3)
 precis(distspp.blm_int2.rise, prob = .95, digits=3)
 precis(distspp.blm_int5.rise, prob = .95, digits=3)

 plot(precis(distspp.blm_int1.rise, prob = .95))
 plot(precis(distspp.blm_int2.rise, prob = .95))
 plot(precis(distspp.blm_int5.rise, prob = .95))
 
compare(distspp.blm_int1.rise, distspp.blm_int2.rise, distspp.blm_int5.rise)
plot(compare(distspp.blm_int1.rise, distspp.blm_int2.rise, distspp.blm_int5.rise))

```
### I'm happy with model int5! Buyilt with additive parameters plus interactions between species and exposure and species and treatment. Also the trace plots have better mixing for int5 than int1. And parameters for exposure-hours x treatment are near zero (int2) whereas those for exposure-hours x species appear much more important.  

```{r distance multi-level Bayesmodels predict, echo=F, eval=F}
# set up dataframe to plot posterior predictions
preddat.base = expand.grid(CalcConc=(seq(0, 2250, 10)), ExposeDummy = c(0,1), SppDummy = c(0,1), RepID=1)

preddat = preddat.base %>%
 mutate(lnCalcConc = log(CalcConc+1)) %>%
  mutate(lnCalcConcC= lnCalcConc - mean(DataSum2496.dist$lnCalcConc))  %>%
  mutate(lnCalcConcC2 = lnCalcConcC^2 ) %>% 
  data.frame()

# predict from posteriors (on transformed scale)
  link_pred <- link(distspp.blm_int2.rise, data = preddat, n=1000) 
  preddat$link_mu_mn <- apply(link_pred, 2, mean)
  preddat$link_PI05 = apply(link_pred, 2, PI, .95)[1,]
  preddat$link_PI95 = apply(link_pred, 2, PI, .95)[2,]
  
 # predict with sim; it's my understanding that this integrates the error estimates too?
  sim_pred <- sim(distspp.blm_int2.rise, data = preddat, n=1000) 
  preddat$sim_mu_mn <- apply(sim_pred, 2, mean)
  preddat$sim_PI05 = apply(sim_pred, 2, PI, .95)[1,]
  preddat$sim_PI95 = apply(sim_pred, 2, PI, .95)[2,]
 
  # plot back-transformed data
  preddat$Spp <- ifelse(preddat$SppDummy==0,"GS","WS")
  preddat$ExposureHrs <- ifelse(preddat$ExposeDummy==0,"24","96")


DistPred_transf_plot2 = ggplot() + 
  geom_point(data=DataSum2496.dist,
             aes(x=(lnCalcConcC),                          
                 y=TotalfishDist_m, 
                 color=factor(Spp))) + 
  geom_ribbon(data = preddat, aes(x=(lnCalcConcC), 
              ymin=link_PI05, ymax=link_PI95), 
              alpha=.4, col="grey70")+
   geom_line(data = preddat, aes(x=(lnCalcConcC), y=link_mu_mn), lwd=.2)+
  facet_grid(Spp~ExposureHrs, scales="free", labeller = labeller(
    ExposureHrs = c("24"="24 Hours Exposure","96"="96 Hours Exposure"),
    Spp = c("GS" = "Green Sturgeon", "WS" = "White Sturgeon")))+
  scale_color_manual(values=c("green3", "steelblue3"), guide=FALSE)+
  ylab("Total Distance Traveled (m)") + 
  scale_x_continuous(name="Bifenthrin Concentration (ng/L)") + #, breaks = seq(-7.5,5, 2.5), labels=(seq(-7.5,5, 2.5)+3.73) ) +
  theme_bw()


DistPred_orig_plot2 = ggplot() + 
  geom_point(data=DataSum2496.dist,
             aes(x=(calcConc),                          
                 y=TotalfishDist_m, 
                 color=factor(Spp))) + 
  geom_ribbon(data = preddat, aes(x=(CalcConc), 
              ymin=link_PI05, ymax=link_PI95), 
              alpha=.4, col="grey70")+
  geom_line(data = preddat, aes(x=(CalcConc), y=link_mu_mn), lwd=.2)+
  facet_grid(Spp~ExposureHrs, scales="free", labeller = labeller(
    ExposureHrs = c("24"="24 Hours Exposure","96"="96 Hours Exposure"),
    Spp = c("GS" = "Green Sturgeon", "WS" = "White Sturgeon")))+
  scale_color_manual(values=c("green3", "steelblue3"), guide=FALSE)+
  ylab("Total Distance Traveled (cm)") + 
  scale_x_continuous(name="Bifenthrin Concentration (ng/L)") + #, breaks = seq(-7.5,5, 2.5), labels=(seq(-7.5,5, 2.5)+3.73) ) +
  theme_bw()

DistPred_transf_plot2
DistPred_orig_plot2
DistPred_transf_plot5
DistPred_orig_plot5
```
     
     
## Velocity Models
### Velocity 
```{r velocity plots, echo=F}

## Summarize movement velocity
 DataSum9696.vel = DataSum2496 %>%
  group_by(index, Trial, Arena, Replicate, ExposureHrs, Treatment, calcConc, Spp, RepID) %>%
  summarize(MnVel = mean(MnVel, na.rm=T), npos = n()) %>%
  ungroup()  %>%
  data.frame()
```



```{r velocity models, echo=F}
vel.lm = lm(MnVel ~ factor(Spp)+ factor(Treatment)*factor(ExposureHrs) , data = DataSum2496.vel)
velspp.lm = lm(MnVel ~ factor(Spp)*factor(Treatment)*factor(ExposureHrs) , data = DataSum2496.vel)

velspp.lmm = lmer(MnVel ~ factor(Spp)*factor(Treatment)*factor(ExposureHrs)+ (1| RepID), data = DataSum2496.vel)

 plot(velspp.lmm)
 qqnorm(resid(velspp.lmm)); qqline(resid(velspp.lmm))
 # plots look okay; the tree-way interaction makes for a better distn of residuals
 
 summary(velspp.lm) # everything is significant except for expsure hrs when modeled with log(conc)
   # effect of species is vastly stronger than anything else
   
   TukeyHSD(aov(velspp.lm))[[4]]
    # for WS, 2000 vs all other treatments are sig diff, and only one other (1000-100)
    # for GS, no GS-GS concentrations were significantly different in this model
   
   TukeyHSD(aov(velspp.lm))[[5]]
    # Ws-GS different at 24 and 69 hours, and WS-WS / GS-GS different at 24 & 96 hours; should do custom contrasts to publish because this is making all possible contrasts. Acutally, should fit in baysian model to publish and compare poterior predicted distribitions to compare. 
  
   TukeyHSD(aov(velspp.lm))[[6]]
    ## if use the three-way interaction model, identify custom contrasts of interest. Thus applies to frequentist of bayesian analysis

```





## Meander and Turn Angle