---
title: "Exposure_Analysis3 - Model Selection"
author: "Anna Steel"
date: "9/3/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(readtext) # need this because the ethovision output .txt files have unusual encoding as UTF-16
library(lme4)
library(rethinking)
library(rprojroot) # only used for find_rstudio_root_file() to set project wd as root
library(patchwork)

knitr::opts_knit$set(root.dir = find_rstudio_root_file()) # sets root directory to match project directory, not rmd file location
```

```{r utility functions, include=FALSE}
# calculate hypotenuse of triangle created by two xy locations

distmov = function(x1,x2,y1,y2) { dm = sqrt((x1-x2)^2 + (y1-y2)^2); return(dm)}

# calculate number steps between detections; use summarized dataset (5 pos/sec)
nstep = function(t2,t1, interv=0.2) {
  if (t2-t1 < 0) stop('time steps backwards?')
  nstep <- ( (t2-t1) / interv)
  return(nstep)
  }

```


## Read in Cleaned Data ("Exposure_Analysis1.Rmd")
```{r read in clean data}
DataSum2496 = read.csv("outputData/Exposure_Outputdata/Bifenthrin_2020_Cleaned_FullData.csv")
```




## Statistical Models, predictions, and other posterior queries for each metric (Total distance travelled, Mean velocity, Meander and Turn angle, Use of center zone (% time), Time Active, Full Rotations vs distance traveled) 


### Distance Models
```{r distance data, echo=F}

## Summarize to take total distance (sum moved in a trial) for each fish replicates
DataSum2496.dist = DataSum2496 %>%
  group_by(index, Trial, Arena, Replicate, ExposureHrs, Treatment, calcConc, Spp, RepID) %>%
  summarize(TotalfishDist_m = sum(SumDistMoved, na.rm=T)/(10*100)) %>%
  ungroup()  %>%
  
  mutate(lnCalcConc = log(calcConc+1)) %>%
  mutate(lnCalcConcC= scale(lnCalcConc, scale=FALSE)) %>%
  mutate(lnCalcConcC2 = lnCalcConcC^2 ) %>% 
   # order of transformations matters (log then scale then square)

  mutate(ExposureHrsC = scale(ExposureHrs, scale=FALSE)) %>%
  data.frame()

MeanDist0 = DataSum2496.dist %>%
  subset(Treatment==0) %>%
  group_by(Spp, ExposureHrs) %>%
  summarize(mean0_dist = mean(TotalfishDist_m)) %>%
  ungroup()  %>%
  # mutate(lnCalcConcC= scale(lnCalcConc, scale=FALSE)) %>%
  # mutate(lnCalcConcC2 = lnCalcConcC^2) %>%
  data.frame()

DataSumDiff.dist = merge(DataSum2496.dist, MeanDist0, all.x=T)
DataSumDiff.dist$DistDiff = DataSumDiff.dist$TotalfishDist_m - DataSumDiff.dist$mean0_dist


```


```{r distance multi-level Bayesmodels, echo=F}
# try setting up the linear model in a bayesian form, same as frequentist model above

DSdist_bmoddat = DataSum2496.dist[,c("TotalfishDist_m","lnCalcConcC","lnCalcConcC2",
                                     "ExposureHrs","Spp","RepID")]
#DSdist_bmoddat$TotalfishDistcm = DSdist_bmoddat$TotalfishDist/10
DSdist_bmoddat$lnCalcConcC = as.numeric(DSdist_bmoddat$lnCalcConcC) 
DSdist_bmoddat$lnCalcConcC2 = as.numeric(DSdist_bmoddat$lnCalcConcC2) 
DSdist_bmoddat$SppDummy <- ifelse(DSdist_bmoddat$Spp=="GS", 0,1)
DSdist_bmoddat$ExposeDummy <- ifelse(DSdist_bmoddat$ExposureHrs=="24", 0,1)

# remove fish with only one timepoint of detection, because cant add random slope with one timepoint
DSdist_bmoddat = DSdist_bmoddat[!(DSdist_bmoddat$RepID %in% paste0(c(0,5,100,500,1000,2000), "-WS-4")),]


distspp.blm_int1.rise = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
     mu  <- a_fish[RepID] + 
             bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + 
             be_fish[RepID]*ExposeDummy + 
             bs*SppDummy + 
             bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2),
        # Wrong way of extending a random intercept; doesn't include correlation between slope and intercept for the same individual
        # a_fish[RepID] ~ dnorm(a,a_sig),
        #   a ~ dcauchy(0,10),
        #   a_sig ~ dcauchy(0,10),
        # be_fish[RepID] ~ dnorm(be,be_sig),
        #   be ~ dcauchy(0,10),
        #   be_sig ~ dcauchy(0,10),
        # Right way, because includes correlation by individual
           c(a_fish,be_fish)[RepID] ~ dmvnorm2(Mu=c(a,be), sigma=sigma_fish, Rho=Rho),
           a ~ dnorm(0,10),
           be ~ dnorm(0,10),
           sigma_fish ~ dcauchy(0,10),
           Rho ~ dlkjcorr(2),
             # not as flat as (1) but biases against strong correlations of intercept and slope
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)

precis(distspp.blm_int1)
precis(distspp.blm_int1.rise)

plot(distspp.blm_int1)
plot(distspp.blm_int1.rise)

compare(distspp.blm_int1.rise, distspp.blm_int1)

# the precis values don't look THAT different. 


distspp.blm_int2.rise = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
    mu  <- a_fish[RepID] + 
             bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + 
             be_fish[RepID]*ExposeDummy + 
             bs*SppDummy + 
             bse*(SppDummy)*(ExposeDummy) +
             bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2) +
             bte1*(ExposeDummy)*(lnCalcConcC) + bte2*(ExposeDummy)*(lnCalcConcC2),
         # does the interaction also need to have the random effect? I hope not =/
           c(a_fish,be_fish)[RepID] ~ dmvnorm2(Mu=c(a,be), sigma=sigma_fish, Rho=Rho),
           a ~ dnorm(0,10),
           be ~ dnorm(0,10),
           sigma_fish ~ dcauchy(0,10),
           Rho ~ dlkjcorr(2),
             # not as flat as (1) but biases against strong correlations of intercept and slope
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        bse ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
        bte1 ~ dnorm(0,10),
        bte2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


distspp.blm_int5.rise = map2stan(
  alist(
    TotalfishDist_m ~ dnorm(mu, sigma),
    mu  <- a_fish[RepID] + 
             bt*(lnCalcConcC) + bt2*(lnCalcConcC2) + 
             be_fish[RepID]*ExposeDummy + 
             bs*SppDummy + 
             bse*(SppDummy)*(ExposeDummy) +
             bts1*(SppDummy)*(lnCalcConcC) + bts2*(SppDummy)*(lnCalcConcC2),
         # does the interaction also need to have the random effect? I hope not =/
           c(a_fish,be_fish)[RepID] ~ dmvnorm2(Mu=c(a,be), sigma=sigma_fish, Rho=Rho),
           a ~ dnorm(0,10),
           be ~ dnorm(0,10),
           sigma_fish ~ dcauchy(0,10),
           Rho ~ dlkjcorr(2),
             # not as flat as (1) but biases against strong correlations of intercept and slope
        bt ~ dnorm(0,10),
        bt2 ~ dnorm(0,10),
        bs ~ dnorm(0,10),
        bse ~ dnorm(0,10),
        bts1 ~ dnorm(0,10),
        bts2 ~ dnorm(0,10),
    sigma ~ dcauchy(0,10)
    ) ,
  data = DSdist_bmoddat, iter = 2000, warmup = 500, chains = 4)


 plot(distspp.blm_int1.rise)
 plot(distspp.blm_int2.rise)
 plot(distspp.blm_int5.rise)
 
 precis(distspp.blm_int1.rise, prob = .95, digits=3)
 precis(distspp.blm_int2.rise, prob = .95, digits=3)
 precis(distspp.blm_int5.rise, prob = .95, digits=3)

 plot(precis(distspp.blm_int1.rise, prob = .95))
 plot(precis(distspp.blm_int2.rise, prob = .95))
 plot(precis(distspp.blm_int5.rise, prob = .95))
 
compare(distspp.blm_int1.rise, distspp.blm_int2.rise, distspp.blm_int5.rise)
plot(compare(distspp.blm_int1.rise, distspp.blm_int2.rise, distspp.blm_int5.rise))

```
### I'm happy with model int5! Buyilt with additive parameters plus interactions between species and exposure and species and treatment. Also the trace plots have better mixing for int5 than int1. And parameters for exposure-hours x treatment are near zero (int2) whereas those for exposure-hours x species appear much more important.  

```{r distance multi-level Bayesmodels predict, echo=F, eval=F}
# set up dataframe to plot posterior predictions
preddat.base = expand.grid(CalcConc=(seq(0, 2250, 10)), ExposeDummy = c(0,1), SppDummy = c(0,1), RepID=1)

preddat = preddat.base %>%
 mutate(lnCalcConc = log(CalcConc+1)) %>%
  mutate(lnCalcConcC= lnCalcConc - mean(DataSum2496.dist$lnCalcConc))  %>%
  mutate(lnCalcConcC2 = lnCalcConcC^2 ) %>% 
  data.frame()

# predict from posteriors (on transformed scale)
  link_pred <- link(distspp.blm_int2.rise, data = preddat, n=1000) 
  preddat$link_mu_mn <- apply(link_pred, 2, mean)
  preddat$link_PI05 = apply(link_pred, 2, PI, .95)[1,]
  preddat$link_PI95 = apply(link_pred, 2, PI, .95)[2,]
  
 # predict with sim; it's my understanding that this integrates the error estimates too?
  sim_pred <- sim(distspp.blm_int2.rise, data = preddat, n=1000) 
  preddat$sim_mu_mn <- apply(sim_pred, 2, mean)
  preddat$sim_PI05 = apply(sim_pred, 2, PI, .95)[1,]
  preddat$sim_PI95 = apply(sim_pred, 2, PI, .95)[2,]
 
  # plot back-transformed data
  preddat$Spp <- ifelse(preddat$SppDummy==0,"GS","WS")
  preddat$ExposureHrs <- ifelse(preddat$ExposeDummy==0,"24","96")


DistPred_transf_plot2 = ggplot() + 
  geom_point(data=DataSum2496.dist,
             aes(x=(lnCalcConcC),                          
                 y=TotalfishDist_m, 
                 color=factor(Spp))) + 
  geom_ribbon(data = preddat, aes(x=(lnCalcConcC), 
              ymin=link_PI05, ymax=link_PI95), 
              alpha=.4, col="grey70")+
   geom_line(data = preddat, aes(x=(lnCalcConcC), y=link_mu_mn), lwd=.2)+
  facet_grid(Spp~ExposureHrs, scales="free", labeller = labeller(
    ExposureHrs = c("24"="24 Hours Exposure","96"="96 Hours Exposure"),
    Spp = c("GS" = "Green Sturgeon", "WS" = "White Sturgeon")))+
  scale_color_manual(values=c("green3", "steelblue3"), guide=FALSE)+
  ylab("Total Distance Traveled (m)") + 
  scale_x_continuous(name="Bifenthrin Concentration (ng/L)") + #, breaks = seq(-7.5,5, 2.5), labels=(seq(-7.5,5, 2.5)+3.73) ) +
  theme_bw()


DistPred_orig_plot2 = ggplot() + 
  geom_point(data=DataSum2496.dist,
             aes(x=(calcConc),                          
                 y=TotalfishDist_m, 
                 color=factor(Spp))) + 
  geom_ribbon(data = preddat, aes(x=(CalcConc), 
              ymin=link_PI05, ymax=link_PI95), 
              alpha=.4, col="grey70")+
  geom_line(data = preddat, aes(x=(CalcConc), y=link_mu_mn), lwd=.2)+
  facet_grid(Spp~ExposureHrs, scales="free", labeller = labeller(
    ExposureHrs = c("24"="24 Hours Exposure","96"="96 Hours Exposure"),
    Spp = c("GS" = "Green Sturgeon", "WS" = "White Sturgeon")))+
  scale_color_manual(values=c("green3", "steelblue3"), guide=FALSE)+
  ylab("Total Distance Traveled (cm)") + 
  scale_x_continuous(name="Bifenthrin Concentration (ng/L)") + #, breaks = seq(-7.5,5, 2.5), labels=(seq(-7.5,5, 2.5)+3.73) ) +
  theme_bw()

DistPred_transf_plot2
DistPred_orig_plot2
DistPred_transf_plot5
DistPred_orig_plot5
```
     
     
## Velocity Models
### Velocity 
```{r velocity plots, echo=F}

## Summarize movement velocity
 DataSum9696.vel = DataSum2496 %>%
  group_by(index, Trial, Arena, Replicate, ExposureHrs, Treatment, calcConc, Spp, RepID) %>%
  summarize(MnVel = mean(MnVel, na.rm=T), npos = n()) %>%
  ungroup()  %>%
  data.frame()
```



```{r velocity models, echo=F}
vel.lm = lm(MnVel ~ factor(Spp)+ factor(Treatment)*factor(ExposureHrs) , data = DataSum2496.vel)
velspp.lm = lm(MnVel ~ factor(Spp)*factor(Treatment)*factor(ExposureHrs) , data = DataSum2496.vel)

velspp.lmm = lmer(MnVel ~ factor(Spp)*factor(Treatment)*factor(ExposureHrs)+ (1| RepID), data = DataSum2496.vel)

 plot(velspp.lmm)
 qqnorm(resid(velspp.lmm)); qqline(resid(velspp.lmm))
 # plots look okay; the tree-way interaction makes for a better distn of residuals
 
 summary(velspp.lm) # everything is significant except for expsure hrs when modeled with log(conc)
   # effect of species is vastly stronger than anything else
   
   TukeyHSD(aov(velspp.lm))[[4]]
    # for WS, 2000 vs all other treatments are sig diff, and only one other (1000-100)
    # for GS, no GS-GS concentrations were significantly different in this model
   
   TukeyHSD(aov(velspp.lm))[[5]]
    # Ws-GS different at 24 and 69 hours, and WS-WS / GS-GS different at 24 & 96 hours; should do custom contrasts to publish because this is making all possible contrasts. Acutally, should fit in baysian model to publish and compare poterior predicted distribitions to compare. 
  
   TukeyHSD(aov(velspp.lm))[[6]]
    ## if use the three-way interaction model, identify custom contrasts of interest. Thus applies to frequentist of bayesian analysis

```





## Meander and Turn Angle