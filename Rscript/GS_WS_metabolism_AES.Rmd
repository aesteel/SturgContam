---
title: "2021 pesticides metabolism"
author: "Vanessa Lo"
date: "June 9, 2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r set up and read in func}
# library(ggplot2);library(plyr);library(dplyr);library(reshape2);library(gtools);library(lubridate);library(magrittr);library(stringr);library(scales);library(tidyr);library(mclust);library(quantreg);library(Hmisc);library(Matrix);library(xlsx);library(modelr);library(tidyverse);library(remotes);library(ggpmisc);library(plotly)

#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides/")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip")

fish.data <- read.csv("fishdata_metabolism_gs_ws.csv", fileEncoding="UTF-8-BOM")
fish.data$date<- as.Date(fish.data$date, format = "%m/%d/%Y")
fish.data$treatment <- ordered(fish.data$treatment, levels = c("white","green","yellow","red","pink","blue"))
fish.data$round <- as.factor(fish.data$round)

# Function to read in raw autoresp text files, skips the first 37 lines and renames columns and sets datetime column to POSIXct 

readclean <- function(x) { y = read.delim(x, skip=38, stringsAsFactors=F)
z = y[,c(1,2,3,4,6,7,10,13,16,19,22,25,28)]
names(z) <- c("DateTime","Phase","BaroP","Salinity","Temp","CH1O2.sat","CH2O2.sat","CH3O2.sat","CH4O2.sat","CH5O2.sat","CH6O2.sat","CH7O2.sat","CH8o2.sat")
z$DateTime <- as.POSIXct(z$DateTime, format = "%m/%d/%Y/%I:%M:%S %p")
z}

O2.saturation<-function(salinity, temp, measured.atmP, perc.sat) {
  
  a=4.9e1
  b=-1.335
  c=2.759e-2
  d=-3.235e-4
  e=1.598e-6
  p=5.516e-1
  q=-1.759e-2
  r=2.253e-4
  s=-2.654e-7
  t=5.362e-8
  A=5.257e1
  B=6.69e3
  C=4.681
  TK=temp+273
  Chloride=(salinity-0.03)/1.805
  atmPsealevel=1013
  MolVol=22.414
  MWO2=32
  
  alpha=a+(b*temp)+(c*temp^2)+(d*temp^3)+(e*temp^4)-(Chloride*(p+(q*temp)+(r*temp^2)+(s*temp^3)+(t*temp^4)))
  bunsen=alpha/1000
  vapP=exp(A-(B/TK)-(C*log(TK)))
  
  umoleO2.per.L<-(((measured.atmP-vapP)/atmPsealevel)*(perc.sat/100)*0.2095*bunsen*1e6*(1/MolVol))
  mgO2.per.L<-umoleO2.per.L*(MWO2/1000)
  pO2.torr<-((measured.atmP-vapP)*((perc.sat/100)*0.2095))*0.75
  pO2.mbar<-pO2.torr/0.75
  pO2.kPa<-pO2.mbar/10
  
  output<-data.frame(salinity, temp, measured.atmP, perc.sat, umoleO2.per.L, mgO2.per.L, pO2.torr, pO2.mbar, pO2.kPa)
  print(output) # I changed this so it only gives me umoleO2.per.L, take out the [5] if you want all the variables
}
```

## GS
### May 30 rd 1 t1
```{r 30May2021 rd1 t1}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("5_30_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_001","gs_002","gs_003","gs_004","gs_005","gs_006","gs_007","gs_008")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_001")
ch.2.meas <- subset(RMR.trial, fishID == "gs_002")
ch.3.meas <- subset(RMR.trial, fishID == "gs_003")
ch.4.meas <- subset(RMR.trial, fishID == "gs_004")
ch.5.meas <- subset(RMR.trial, fishID == "gs_005")
ch.6.meas <- subset(RMR.trial, fishID == "gs_006")
ch.7.meas <- subset(RMR.trial, fishID == "gs_007")
ch.8.meas <- subset(RMR.trial, fishID == "gs_008")

# visualize one fish
p=ggplot(data=ch.6.meas, aes(x=Time.m, y=as.numeric(mgO2)))

p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_001")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_002")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_003")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_004")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_005")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_006")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_007")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_008")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial1 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial1)

ggplot(O2.all.trial1, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial1<- mutate(O2.all.trial1, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial1<- mutate(O2.all.trial1, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial1)

# plot whole body MO2
ggplot(O2.all.trial1, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial1, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()
# something is off with phase M1 and M7, remove those values

#Remove phase 1 and 7
test <- filter(O2.all.trial1, Phase != "M7" & Phase != "M1")

ggplot(test, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

O2.all.trial1 <- test
###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial1[order(O2.all.trial1$fishID,O2.all.trial1$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial1 <- Reduce(rbind, lowest3)
# low3MO2.gs <- low3MO2_trial1

```

### May 30 rd 2 t2
```{r 30May2021 rd2 t2}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("5_30_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_009","gs_010","gs_011","gs_012","gs_013","gs_014","gs_015","gs_016")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_009")
ch.2.meas <- subset(RMR.trial, fishID == "gs_010")
ch.3.meas <- subset(RMR.trial, fishID == "gs_011")
ch.4.meas <- subset(RMR.trial, fishID == "gs_012")
ch.5.meas <- subset(RMR.trial, fishID == "gs_013")
ch.6.meas <- subset(RMR.trial, fishID == "gs_014")
ch.7.meas <- subset(RMR.trial, fishID == "gs_015")
ch.8.meas <- subset(RMR.trial, fishID == "gs_016")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_009")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_010")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_011")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_012")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_013")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_014")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_015")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_016")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial2 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial2)

ggplot(O2.all.trial2, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial2<- mutate(O2.all.trial2, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial2<- mutate(O2.all.trial2, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial2)

# plot whole body MO2
ggplot(O2.all.trial2, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial2, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

O2.all <- rbind(O2.all.trial1,O2.all.trial2)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial2[order(O2.all.trial2$fishID,O2.all.trial2$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial2 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2_trial1,low3MO2_trial2)

ggplot(O2.all, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()
```

### May 31 rd 1 t3
```{r 31May2021 rd1 t3}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("5_31_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_017","gs_018","gs_019","gs_020","gs_021","gs_022","gs_023","gs_024")
names(RMR)[6:13] <- Name.vec
#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_017")
ch.2.meas <- subset(RMR.trial, fishID == "gs_018")
ch.3.meas <- subset(RMR.trial, fishID == "gs_019")
ch.4.meas <- subset(RMR.trial, fishID == "gs_020")
ch.5.meas <- subset(RMR.trial, fishID == "gs_021")
ch.6.meas <- subset(RMR.trial, fishID == "gs_022")
ch.7.meas <- subset(RMR.trial, fishID == "gs_023")
ch.8.meas <- subset(RMR.trial, fishID == "gs_024")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_017")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_018")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_019")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_020")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_021")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_022")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_023")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_024")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial3 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial3)

ggplot(O2.all.trial3, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial3<- mutate(O2.all.trial3, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial3<- mutate(O2.all.trial3, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial3)

# remove bg bact values
O2.all.trial3 <- filter(O2.all.trial3, mass.specific.mgO2ghr > 0.1)

# plot whole body MO2
ggplot(O2.all.trial3, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial3, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

O2.all <- rbind(O2.all,O2.all.trial3)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial3[order(O2.all.trial3$fishID,O2.all.trial3$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial3 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial3)
```

### May 31 rd 2 t4
```{r 31May2021 rd2 t4}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("5_31_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_025","gs_026","gs_027","gs_028","gs_029","gs_030","gs_031","gs_032")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_025")
ch.2.meas <- subset(RMR.trial, fishID == "gs_026")
ch.3.meas <- subset(RMR.trial, fishID == "gs_027")
ch.4.meas <- subset(RMR.trial, fishID == "gs_028")
ch.5.meas <- subset(RMR.trial, fishID == "gs_029")
ch.6.meas <- subset(RMR.trial, fishID == "gs_030")
ch.7.meas <- subset(RMR.trial, fishID == "gs_031")
ch.8.meas <- subset(RMR.trial, fishID == "gs_032")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_025")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_026")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_027")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_028")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_029")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_030")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_031")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_032")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial4 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial4)

ggplot(O2.all.trial4, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial4<- mutate(O2.all.trial4, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial4<- mutate(O2.all.trial4, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial4)

# plot whole body MO2
ggplot(O2.all.trial4, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial4, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial4 <- filter(O2.all.trial4, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial4)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial4[order(O2.all.trial4$fishID,O2.all.trial4$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial4 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial4)
```

### June 1 rd 1 t5
```{r 1June2021 rd1 t5}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_1_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_033","gs_034","gs_035","gs_036","gs_037","gs_038","gs_039","gs_040")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()
# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_033")
ch.2.meas <- subset(RMR.trial, fishID == "gs_034")
ch.3.meas <- subset(RMR.trial, fishID == "gs_035")
ch.4.meas <- subset(RMR.trial, fishID == "gs_036")
ch.5.meas <- subset(RMR.trial, fishID == "gs_037")
ch.6.meas <- subset(RMR.trial, fishID == "gs_038")
ch.7.meas <- subset(RMR.trial, fishID == "gs_039")
ch.8.meas <- subset(RMR.trial, fishID == "gs_040")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_033")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_034")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_035")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_036")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_037")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_038")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_039")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_040")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial5 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial5)

ggplot(O2.all.trial5, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial5<- mutate(O2.all.trial5, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial5<- mutate(O2.all.trial5, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial5)

# plot whole body MO2
ggplot(O2.all.trial5, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial5, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial5 <- filter(O2.all.trial5, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial5)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial5[order(O2.all.trial5$fishID,O2.all.trial5$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial5 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial5)

```

### June 1 rd 2 t6
```{r 1June2021 rd2 t6}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_1_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_041","gs_042","gs_043","gs_044","gs_045","gs_046","gs_047","gs_048")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_041")
ch.2.meas <- subset(RMR.trial, fishID == "gs_042")
ch.3.meas <- subset(RMR.trial, fishID == "gs_043")
ch.4.meas <- subset(RMR.trial, fishID == "gs_044")
ch.5.meas <- subset(RMR.trial, fishID == "gs_045")
ch.6.meas <- subset(RMR.trial, fishID == "gs_046")
ch.7.meas <- subset(RMR.trial, fishID == "gs_047")
ch.8.meas <- subset(RMR.trial, fishID == "gs_048")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_041")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_042")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_043")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_044")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_045")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_046")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_047")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_048")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial6 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial6)

ggplot(O2.all.trial6, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial6<- mutate(O2.all.trial6, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial6<- mutate(O2.all.trial6, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial6)

# plot whole body MO2
ggplot(O2.all.trial6, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial6, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial6 <- filter(O2.all.trial6, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial6)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial6[order(O2.all.trial6$fishID,O2.all.trial6$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial6 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial6)
```

### June 1 rd 3 t7
```{r 1June2021 rd3 t7}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_1_21_round3_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_049","gs_050","gs_051","gs_052","gs_053","gs_054","gs_055","gs_056")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_049")
ch.2.meas <- subset(RMR.trial, fishID == "gs_050")
ch.3.meas <- subset(RMR.trial, fishID == "gs_051")
ch.4.meas <- subset(RMR.trial, fishID == "gs_052")
ch.5.meas <- subset(RMR.trial, fishID == "gs_053")
ch.6.meas <- subset(RMR.trial, fishID == "gs_054")
ch.7.meas <- subset(RMR.trial, fishID == "gs_055")
ch.8.meas <- subset(RMR.trial, fishID == "gs_056")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_049")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_050")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_051")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_052")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_053")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_054")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_055")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_056")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial7 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial7)

ggplot(O2.all.trial7, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial7<- mutate(O2.all.trial7, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial7<- mutate(O2.all.trial7, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial7)

# plot whole body MO2
ggplot(O2.all.trial7, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial7, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial7 <- filter(O2.all.trial7, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial7)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial7[order(O2.all.trial7$fishID,O2.all.trial7$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial7 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial7)

```

### June 2 rd 1 t8
```{r 2June2021 rd1 t8}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_2_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_057","gs_058","gs_059","gs_060","gs_061","gs_062","gs_063","gs_064")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_057")
ch.2.meas <- subset(RMR.trial, fishID == "gs_058")
ch.3.meas <- subset(RMR.trial, fishID == "gs_059")
ch.4.meas <- subset(RMR.trial, fishID == "gs_060")
ch.5.meas <- subset(RMR.trial, fishID == "gs_061")
ch.6.meas <- subset(RMR.trial, fishID == "gs_062")
ch.7.meas <- subset(RMR.trial, fishID == "gs_063")
ch.8.meas <- subset(RMR.trial, fishID == "gs_064")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_057")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_058")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_059")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_060")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_061")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_062")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_063")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_064")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial8 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial8)

ggplot(O2.all.trial8, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial8<- mutate(O2.all.trial8, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial8<- mutate(O2.all.trial8, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial8)

# plot whole body MO2
ggplot(O2.all.trial8, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial8, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial8 <- filter(O2.all.trial8, mass.specific.mgO2ghr > 0.1 & Phase != "M5")

O2.all <- rbind(O2.all,O2.all.trial8)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial8[order(O2.all.trial8$fishID,O2.all.trial8$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial8 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial8)

```

### June 2 rd 2 t9
```{r 2June2021 rd2 t9}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_2_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_065","gs_066","gs_067","gs_068","gs_069","gs_070","gs_071","gs_072")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_065")
ch.2.meas <- subset(RMR.trial, fishID == "gs_066")
ch.3.meas <- subset(RMR.trial, fishID == "gs_067")
ch.4.meas <- subset(RMR.trial, fishID == "gs_068")
ch.5.meas <- subset(RMR.trial, fishID == "gs_069")
ch.6.meas <- subset(RMR.trial, fishID == "gs_070")
ch.7.meas <- subset(RMR.trial, fishID == "gs_071")
ch.8.meas <- subset(RMR.trial, fishID == "gs_072")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_065")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_066")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_067")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_068")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_069")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_070")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_071")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_072")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial9 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial9)

ggplot(O2.all.trial9, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial9<- mutate(O2.all.trial9, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial9<- mutate(O2.all.trial9, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial9)

# plot whole body MO2
ggplot(O2.all.trial9, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial9, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial9 <- filter(O2.all.trial9, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial9)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial9[order(O2.all.trial9$fishID,O2.all.trial9$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial9 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial9)

```

### June 2 rd 3 t10
```{r 2June2021 rd3 t10}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_2_21_round3_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_073","gs_074","gs_075","gs_076","gs_077","gs_078","gs_079","gs_080")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_073")
ch.2.meas <- subset(RMR.trial, fishID == "gs_074")
ch.3.meas <- subset(RMR.trial, fishID == "gs_075")
ch.4.meas <- subset(RMR.trial, fishID == "gs_076")
ch.5.meas <- subset(RMR.trial, fishID == "gs_077")
ch.6.meas <- subset(RMR.trial, fishID == "gs_078")
ch.7.meas <- subset(RMR.trial, fishID == "gs_079")
ch.8.meas <- subset(RMR.trial, fishID == "gs_080")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_073")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_074")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_075")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_076")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_077")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_078")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_079")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_080")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial10 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial10)

ggplot(O2.all.trial10, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial10<- mutate(O2.all.trial10, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial10<- mutate(O2.all.trial10, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial10)

# plot whole body MO2
ggplot(O2.all.trial10, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial10, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial10 <- filter(O2.all.trial10, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial10)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial10[order(O2.all.trial10$fishID,O2.all.trial10$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial10 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial10)

```

### June 3 rd 1 t11
```{r 3June2021 rd1 t11}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_3_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_081","gs_082","gs_083","gs_084","gs_085","gs_086","gs_087","gs_088")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_081")
ch.2.meas <- subset(RMR.trial, fishID == "gs_082")
ch.3.meas <- subset(RMR.trial, fishID == "gs_083")
ch.4.meas <- subset(RMR.trial, fishID == "gs_084")
ch.5.meas <- subset(RMR.trial, fishID == "gs_085")
ch.6.meas <- subset(RMR.trial, fishID == "gs_086")
ch.7.meas <- subset(RMR.trial, fishID == "gs_087")
ch.8.meas <- subset(RMR.trial, fishID == "gs_088")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_081")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_082")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_083")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_084")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_085")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_086")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_087")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_088")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial11 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial11)

ggplot(O2.all.trial11, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial11<- mutate(O2.all.trial11, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial11<- mutate(O2.all.trial11, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial11)

# plot whole body MO2
ggplot(O2.all.trial11, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial11, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial11 <- filter(O2.all.trial11, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial11)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial11[order(O2.all.trial11$fishID,O2.all.trial11$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial11 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial11)

```

### June 3 rd 2 t12
```{r 3June2021 rd2 t12}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_3_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_089","gs_090","gs_091","gs_092","gs_093","gs_094","gs_095","gs_096")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_089")
ch.2.meas <- subset(RMR.trial, fishID == "gs_090")
ch.3.meas <- subset(RMR.trial, fishID == "gs_091")
ch.4.meas <- subset(RMR.trial, fishID == "gs_092")
ch.5.meas <- subset(RMR.trial, fishID == "gs_093")
ch.6.meas <- subset(RMR.trial, fishID == "gs_094")
ch.7.meas <- subset(RMR.trial, fishID == "gs_095")
ch.8.meas <- subset(RMR.trial, fishID == "gs_096")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_089")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_090")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_091")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_092")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_093")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_094")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_095")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_096")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial12 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial12)

ggplot(O2.all.trial12, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial12<- mutate(O2.all.trial12, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial12<- mutate(O2.all.trial12, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial12)

# plot whole body MO2
ggplot(O2.all.trial12, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial12, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial12 <- filter(O2.all.trial12, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial12)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial12[order(O2.all.trial12$fishID,O2.all.trial12$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial12 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial12)

```

### June 3 rd 3 t13
```{r 3June2021 rd3 t13}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_3_21_round3_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_097","gs_098","gs_099","gs_100","gs_101","gs_102","gs_103","gs_104")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_097")
ch.2.meas <- subset(RMR.trial, fishID == "gs_098")
ch.3.meas <- subset(RMR.trial, fishID == "gs_099")
ch.4.meas <- subset(RMR.trial, fishID == "gs_100")
ch.5.meas <- subset(RMR.trial, fishID == "gs_101")
ch.6.meas <- subset(RMR.trial, fishID == "gs_102")
ch.7.meas <- subset(RMR.trial, fishID == "gs_103")
ch.8.meas <- subset(RMR.trial, fishID == "gs_104")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_097")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_098")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_099")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_100")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_101")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_102")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_103")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_104")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial13 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial13)

ggplot(O2.all.trial13, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial13<- mutate(O2.all.trial13, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial13<- mutate(O2.all.trial13, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial13)

# plot whole body MO2
ggplot(O2.all.trial13, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial13, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial13 <- filter(O2.all.trial13, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial13)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial13[order(O2.all.trial13$fishID,O2.all.trial13$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial13 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial13)
```

### June 4 rd 1 t14
```{r 4June2021 rd1 t14}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_4_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_105","gs_106","gs_107","gs_108","gs_109","gs_110","gs_111","gs_112")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_105")
ch.2.meas <- subset(RMR.trial, fishID == "gs_106")
ch.3.meas <- subset(RMR.trial, fishID == "gs_107")
ch.4.meas <- subset(RMR.trial, fishID == "gs_108")
ch.5.meas <- subset(RMR.trial, fishID == "gs_109")
ch.6.meas <- subset(RMR.trial, fishID == "gs_110")
ch.7.meas <- subset(RMR.trial, fishID == "gs_111")
ch.8.meas <- subset(RMR.trial, fishID == "gs_112")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_105")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_106")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_107")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_108")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_109")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_110")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_111")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_112")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial14 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial14)

ggplot(O2.all.trial14, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial14<- mutate(O2.all.trial14, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial14<- mutate(O2.all.trial14, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial14)

# plot whole body MO2
ggplot(O2.all.trial14, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial14, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial14 <- filter(O2.all.trial14, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial14)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial14[order(O2.all.trial14$fishID,O2.all.trial14$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial14 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial14)
```

### June 4 rd 2 t15
```{r 4June2021 rd2 t15}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/rawdata")

RMR_raw <- readclean("6_4_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("gs_113","gs_114","gs_115","gs_116","gs_117","gs_118","gs_119","gs_120")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "gs_113")
ch.2.meas <- subset(RMR.trial, fishID == "gs_114")
ch.3.meas <- subset(RMR.trial, fishID == "gs_115")
ch.4.meas <- subset(RMR.trial, fishID == "gs_116")
ch.5.meas <- subset(RMR.trial, fishID == "gs_117")
ch.6.meas <- subset(RMR.trial, fishID == "gs_118")
ch.7.meas <- subset(RMR.trial, fishID == "gs_119")
ch.8.meas <- subset(RMR.trial, fishID == "gs_120")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "gs_113")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "gs_114")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "gs_115")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "gs_116")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "gs_117")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "gs_118")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "gs_119")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "gs_120")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial15 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial15)

ggplot(O2.all.trial15, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial15<- mutate(O2.all.trial15, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial15<- mutate(O2.all.trial15, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial15)

# plot whole body MO2
ggplot(O2.all.trial15, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial15, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial15 <- filter(O2.all.trial15, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial15)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial15[order(O2.all.trial15$fishID,O2.all.trial15$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial15 <- Reduce(rbind, lowest3)
# low3MO2.gs <- rbind(low3MO2.gs,low3MO2_trial15)
```



```{r add chem analysis to dataframe}
# add measured concentrations to the dataframe
fipGS_chemanalysis = read.csv("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/ChemAnalysis_GSFipronil_2021_Reduced.csv")

# add nom conc to dataframe 
O2.all$NomConc = NA
for(i in 1:nrow(O2.all)) {
ifelse(O2.all$treatment[i]=="white", O2.all$NomConc[i]<-0, 
   ifelse(O2.all$treatment[i]=="green", O2.all$NomConc[i]<-1,
       ifelse(O2.all$treatment[i]=="yellow", O2.all$NomConc[i]<-10,
   ifelse(O2.all$treatment[i]=="red", O2.all$NomConc[i]<-100,
       ifelse(O2.all$treatment[i]=="blue", O2.all$NomConc[i]<-500, O2.all$NomConc[i]<-1000)) ) ) )
}

O2.all.temp <- merge(O2.all, filter(fipGS_chemanalysis, Contam=="Fipronil"), all.x=T)
O2.all.temp$CalcConc = as.numeric(O2.all.temp$CalcConc)

```

```{r calc lowMO2}


write.csv(O2.all.temp, "/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 GS Fipronil/Metabolism_GSfip/All.O2slope.Measures.csv")

O2.all = O2.all.temp

hist(O2.all$r2)
hist(filter(O2.all, r2<0.90)$r2)

# fix Date
O2.all$date = as.Date(O2.all$DateTime)

# filter out poor r2
O2.all.r2filt <- filter(O2.all, r2 > 0.98)

# Calculate lowMO2 - keep lowest 3
# the rationale (as guessed by Anna) is that the least slope in the line (ie: the lowers O2 use per hr) corresponds with the most relaxed state of the fish which is the goal since this is an RMR not a MMR
sort.O2 <- O2.all.r2filt[order(O2.all.r2filt$fishID, O2.all.r2filt$mass.specific.mgO2ghr),]

lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3) # creates a list
low3MO2.gs <- Reduce(rbind, lowest3) # merges the list back into a dataframe
 # 13 fish with no data points (4 of 8 from day 1)
 # 6 fish with only 1 data point
 # 6 fish with only 2 data points
 # It is likely all these fish have low r2 traces
  low3.n = as.data.frame(table(low3MO2.gs$fishID))
  problem.fishID = low3.n[low3.n$Freq!=3,]$Var1
  
# number of fish per treatment with no traces  
  table(unique(O2.all[O2.all$fishID %in% low3.n[low3.n$Freq==0,]$Var1, 
                      c("fishID","treatment")])$treatment)
   # white  green yellow    red   pink   blue 
   #     3      2      3      2      1      2 

# number of fish per treatment with < 3 traces 
  table(unique(O2.all[O2.all$fishID %in% 
                        problem.fishID,c("fishID","treatment")])$treatment)
   # white  green yellow    red   pink   blue 
   #   6      4      5      2      4      4 
  
# remaining sample sizes per treatment if remove all those wiht < 3 traces  
  table(unique(O2.all[!(O2.all$fishID %in% 
                        problem.fishID),c("fishID","treatment")])$treatment)
   # white  green yellow    red   pink   blue 
   #  14     16     15     18     16     16 
  
  
  
# reduce dataset to only those with 3 metabolism traces with r2 over 0.98
low3MO2.gs.3 = low3MO2.gs[!(low3MO2.gs$fishID %in% problem.fishID),]
  


# Mean of the lowest 3 values (including all fish with data)
mean.O2 <- aggregate(low3MO2.gs$mass.specific.mgO2ghr, 
                     by=list(low3MO2.gs$fishID, low3MO2.gs$CalcConc), mean)
names(mean.O2) <- c("fishID","CalcConc", "mass.spec.MO2")

O2.gs.final <- merge(mean.O2, fish.data, by = "fishID")
str(O2.gs.final)
  # n=70 (107 if include blue and pink, but these data are tossed out for pubs); if remove calcconc from summarization they can stay in

# Mean of the lowest 3 values (including only fish with at least 3 data points)
mean.O2.3 <- aggregate(low3MO2.gs.3$mass.specific.mgO2ghr, 
                       by=list(low3MO2.gs.3$fishID, low3MO2.gs.3$CalcConc), mean)
names(mean.O2.3) <- c("fishID","CalcConc", "mass.spec.MO2")

O2.gs.final.3 <- merge(mean.O2.3, fish.data, by = "fishID")
str(O2.gs.final.3)
 # n=63 (95 if include blue and pink)
```


### GS data plots

```{r QC plots}

names(low3MO2.gs.3)
ggplot(low3MO2.gs.3, aes(x= Phase, y = mass.specific.mgO2ghr, color = treatment))+
  geom_jitter(width=.1) + #scale_color_discrete(guide=FALSE) + 
  theme_bw()

ggplot(low3MO2.gs.3, aes(x= chamber, y = mass.specific.mgO2ghr, color = treatment))+
  geom_jitter(width=.1) + facet_wrap(.~date) + 
    theme_bw()

ggplot(low3MO2.gs.3, aes(x= round, y = mass.specific.mgO2ghr, color = log(CalcConc+1)))+
  geom_jitter(width=.3) +  facet_wrap(.~date) + 
    theme_bw()


names(O2.gs.final.3)
ggplot(O2.gs.final.3, aes(x= chamber, y = mass.spec.MO2, color = log(CalcConc+1)))+
  geom_jitter(width=.1) + facet_wrap(.~date) + 
    theme_bw()

ggplot(O2.gs.final.3, aes(x= round, y = mass.spec.MO2, color = treatment))+
  geom_jitter(width=.3) +  facet_wrap(.~date) + 
    theme_bw()


```

```{r output plots}
O2.gs.final.3_expose4 = filter(O2.gs.final.3, treatment %in% c("white","green","yellow","red"))

ggplot(O2.gs.final.3_expose4, aes(x = as.factor(CalcConc), y = mass.spec.MO2))+
  geom_boxplot(fill="grey80") +
  scale_x_discrete(labels = c("0","1","10","100"), name= "Fipronil\nNominal Exposure Concentration (ug/L)" ) + 
  ylab("Mass Specific Metabolic Rate") + 
  theme_bw()


mlm.gs.0 = lmer(mass.spec.MO2 ~ 1 + (1|chamber), data = O2.gs.final.3_expose4)
 summary(mlm.gs.0)
 ranef(mlm.gs.0)
 
mlm.gs.1 = lmer(mass.spec.MO2 ~ log(CalcConc+1) + (1|chamber), data = O2.gs.final.3_expose4)
 summary(mlm.gs.1)
 ranef(mlm.gs.1)
 anova(mlm.gs.1)
 afex::mixed(mass.spec.MO2 ~ log(CalcConc+1) + (1|chamber), data = O2.gs.final.3_expose4)
  # p = 0.264, estDF = 55.87
   
 
mlm.gs.2 = lmer(mass.spec.MO2 ~ log(CalcConc+1)  + (1|round), data = O2.gs.final.3_expose4)
 summary(mlm.gs.2)
 ranef(mlm.gs.2)
 # random effect explains NO variance, even when there isnt a fixed effect
 # same model with date is singular...

 AIC(mlm.gs.0) - AIC(mlm.gs.1)
  # delta AIC = 9.366
 
m.gs.1 = lm(mass.spec.MO2 ~ log(CalcConc+1) , data = O2.gs.final.3_expose4)
 summary(m.gs.1)
 summary(aov(m.gs.1))
  
 
```


### No mass
```{r}
# 
# mean.O2.no.mass <- aggregate(O2.gs.final.3_expose4$mgO2hpos, by=list(O2.gs.final.3_expose4$fishID), mean)
# names(mean.O2.no.mass) <- c("fishID","ind.MO2")
# 
# gs.no.mass <- merge(mean.O2.no.mass, fish.data, by = "fishID")
# all.gs <- merge(O2.gs.final, gs.no.mass, by = "fishID")
# # write.csv(all.gs,"2021_final_GS_metabolism.csv")
# 
# ggplot(gs.no.mass, aes(x=length.mm.x, y=mass.g.x, color=CalcConc)) + geom_point() + 
# 
# ggplot(gs.no.mass, aes(x = treatment, y = ind.MO2))+
#   geom_boxplot()+
#   ylab("Whole Body Metabolic Rate (mgO2/h)")+
#   theme_bw()
# 
# my.formula <- y ~ x
# ggplot(gs.no.mass, aes(x = weight.g, y = ind.MO2, color = treatment))+
#   geom_point()+
#   geom_smooth(method = "lm",se = FALSE)+
#   scale_y_continuous(trans="log10")+
#   scale_x_continuous(trans="log10")+
#    ylab("Metabolic Rate (mgO2/h/individual)")+
#   geom_smooth(aes(group=treatment), method="lm", linetype = "dashed", size = .5, formula = my.formula) +
#   stat_poly_eq(formula = my.formula, aes(label = paste(..eq.label..,..rr.label.., sep = "~~~")), parse = TRUE)+
#   theme_bw()
#   
```





## WS
### June 28 rd 1 t1
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_6_28_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_001","ws_002","ws_003","ws_004","ws_005","ws_006","ws_007","ws_008")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_001")
ch.2.meas <- subset(RMR.trial, fishID == "ws_002")
ch.3.meas <- subset(RMR.trial, fishID == "ws_003")
ch.4.meas <- subset(RMR.trial, fishID == "ws_004")
ch.5.meas <- subset(RMR.trial, fishID == "ws_005")
ch.6.meas <- subset(RMR.trial, fishID == "ws_006")
ch.7.meas <- subset(RMR.trial, fishID == "ws_007")
ch.8.meas <- subset(RMR.trial, fishID == "ws_008")

# visualize one fish
p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(mgO2)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_001")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_002")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_003")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_004")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_005")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_006")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_007")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_008")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial1 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial1)

ggplot(O2.all.trial1, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial1<- mutate(O2.all.trial1, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial1<- mutate(O2.all.trial1, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial1)

# plot whole body MO2
ggplot(O2.all.trial1, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial1, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial1 <- filter(O2.all.trial1, mass.specific.mgO2ghr > 0.1)

O2.all <- O2.all.trial1
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial1[order(O2.all.trial1$fishID,O2.all.trial1$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial1 <- Reduce(rbind, lowest3)
# low3MO2.ws <- low3MO2_trial1
```

### June 28 rd 2 t2
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_6_28_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]


#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_009","ws_010","ws_011","ws_012","ws_013","ws_014","ws_015","ws_016")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_009")
ch.2.meas <- subset(RMR.trial, fishID == "ws_010")
ch.3.meas <- subset(RMR.trial, fishID == "ws_011")
ch.4.meas <- subset(RMR.trial, fishID == "ws_012")
ch.5.meas <- subset(RMR.trial, fishID == "ws_013")
ch.6.meas <- subset(RMR.trial, fishID == "ws_014")
ch.7.meas <- subset(RMR.trial, fishID == "ws_015")
ch.8.meas <- subset(RMR.trial, fishID == "ws_016")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_009")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_010")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_011")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_012")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_013")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_014")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_015")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_016")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)

str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial2 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial2)

ggplot(O2.all.trial2, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial2<- mutate(O2.all.trial2, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial2<- mutate(O2.all.trial2, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial2)

# plot whole body MO2
ggplot(O2.all.trial2, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial2, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial2 <- filter(O2.all.trial2, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all.trial1,O2.all.trial2)


###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial2[order(O2.all.trial2$fishID,O2.all.trial2$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial2 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2_trial1,low3MO2_trial2)
# 
# ggplot(O2.all, aes(x=Phase, y=mass.specific.mgO2ghr))+
#   geom_point(aes(color=fishID))+
#   theme_bw()

```

### June 28 rd 3 t3
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_6_28_21_round3_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_017","ws_018","ws_019","ws_020","ws_021","ws_022","ws_023","ws_024")
names(RMR)[6:13] <- Name.vec
#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_017")
ch.2.meas <- subset(RMR.trial, fishID == "ws_018")
ch.3.meas <- subset(RMR.trial, fishID == "ws_019")
ch.4.meas <- subset(RMR.trial, fishID == "ws_020")
ch.5.meas <- subset(RMR.trial, fishID == "ws_021")
ch.6.meas <- subset(RMR.trial, fishID == "ws_022")
ch.7.meas <- subset(RMR.trial, fishID == "ws_023")
ch.8.meas <- subset(RMR.trial, fishID == "ws_024")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_017")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_018")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_019")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_020")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_021")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_022")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_023")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_024")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial3 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial3)

ggplot(O2.all.trial3, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial3<- mutate(O2.all.trial3, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial3<- mutate(O2.all.trial3, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial3)

# plot whole body MO2
ggplot(O2.all.trial3, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial3, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial3 <- filter(O2.all.trial3, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial3)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial3[order(O2.all.trial3$fishID,O2.all.trial3$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial3 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial3)
```

### June 29 rd 1 t4
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_6_29_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_025","ws_026","ws_027","ws_028","ws_029","ws_030","ws_031","ws_032")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_025")
ch.2.meas <- subset(RMR.trial, fishID == "ws_026")
ch.3.meas <- subset(RMR.trial, fishID == "ws_027")
ch.4.meas <- subset(RMR.trial, fishID == "ws_028")
ch.5.meas <- subset(RMR.trial, fishID == "ws_029")
ch.6.meas <- subset(RMR.trial, fishID == "ws_030")
ch.7.meas <- subset(RMR.trial, fishID == "ws_031")
ch.8.meas <- subset(RMR.trial, fishID == "ws_032")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_025")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_026")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_027")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_028")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_029")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_030")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_031")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_032")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial4 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial4)

ggplot(O2.all.trial4, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial4<- mutate(O2.all.trial4, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial4<- mutate(O2.all.trial4, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial4)

# plot whole body MO2
ggplot(O2.all.trial4, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial4, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial4 <- filter(O2.all.trial4, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial4)

# ###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial4[order(O2.all.trial4$fishID,O2.all.trial4$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial4 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial4)
```

### June 29 rd 2 t5
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_6_29_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_033","ws_034","ws_035","ws_036","ws_037","ws_038","ws_039","ws_040")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()
# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_033")
ch.2.meas <- subset(RMR.trial, fishID == "ws_034")
ch.3.meas <- subset(RMR.trial, fishID == "ws_035")
ch.4.meas <- subset(RMR.trial, fishID == "ws_036")
ch.5.meas <- subset(RMR.trial, fishID == "ws_037")
ch.6.meas <- subset(RMR.trial, fishID == "ws_038")
ch.7.meas <- subset(RMR.trial, fishID == "ws_039")
ch.8.meas <- subset(RMR.trial, fishID == "ws_040")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_033")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_034")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_035")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_036")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_037")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_038")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_039")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_040")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial5 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial5)

ggplot(O2.all.trial5, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial5<- mutate(O2.all.trial5, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial5<- mutate(O2.all.trial5, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial5)

# plot whole body MO2
ggplot(O2.all.trial5, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial5, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial5 <- filter(O2.all.trial5, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial5)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial5[order(O2.all.trial5$fishID,O2.all.trial5$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial5 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial5)
```

### June 29 rd 3 t6
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_6_29_21_round3_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_041","ws_042","ws_043","ws_044","ws_045","ws_046","ws_047","ws_048")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_041")
ch.2.meas <- subset(RMR.trial, fishID == "ws_042")
ch.3.meas <- subset(RMR.trial, fishID == "ws_043")
ch.4.meas <- subset(RMR.trial, fishID == "ws_044")
ch.5.meas <- subset(RMR.trial, fishID == "ws_045")
ch.6.meas <- subset(RMR.trial, fishID == "ws_046")
ch.7.meas <- subset(RMR.trial, fishID == "ws_047")
ch.8.meas <- subset(RMR.trial, fishID == "ws_048")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_041")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_042")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_043")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_044")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_045")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_046")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_047")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_048")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial6 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial6)

ggplot(O2.all.trial6, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial6<- mutate(O2.all.trial6, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial6<- mutate(O2.all.trial6, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial6)

# plot whole body MO2
ggplot(O2.all.trial6, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial6, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial6 <- filter(O2.all.trial6, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial6)

# ###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial6[order(O2.all.trial6$fishID,O2.all.trial6$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial6 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial6)
```

### June 30 rd 1 t7
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_6_30_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_049","ws_050","ws_051","ws_052","ws_053","ws_054","ws_055","ws_056")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_049")
ch.2.meas <- subset(RMR.trial, fishID == "ws_050")
ch.3.meas <- subset(RMR.trial, fishID == "ws_051")
ch.4.meas <- subset(RMR.trial, fishID == "ws_052")
ch.5.meas <- subset(RMR.trial, fishID == "ws_053")
ch.6.meas <- subset(RMR.trial, fishID == "ws_054")
ch.7.meas <- subset(RMR.trial, fishID == "ws_055")
ch.8.meas <- subset(RMR.trial, fishID == "ws_056")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_049")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_050")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_051")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_052")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_053")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_054")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_055")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_056")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial7 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial7)

ggplot(O2.all.trial7, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial7<- mutate(O2.all.trial7, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial7<- mutate(O2.all.trial7, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial7)

# plot whole body MO2
ggplot(O2.all.trial7, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial7, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial7 <- filter(O2.all.trial7, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial7)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial7[order(O2.all.trial7$fishID,O2.all.trial7$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial7 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial7)
```

### June 30 rd 2 t8
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_6_30_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_057","ws_058","ws_059","ws_060","ws_061","ws_062","ws_063","ws_064")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_057")
ch.2.meas <- subset(RMR.trial, fishID == "ws_058")
ch.3.meas <- subset(RMR.trial, fishID == "ws_059")
ch.4.meas <- subset(RMR.trial, fishID == "ws_060")
ch.5.meas <- subset(RMR.trial, fishID == "ws_061")
ch.6.meas <- subset(RMR.trial, fishID == "ws_062")
ch.7.meas <- subset(RMR.trial, fishID == "ws_063")
ch.8.meas <- subset(RMR.trial, fishID == "ws_064")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_057")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_058")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_059")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_060")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_061")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_062")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_063")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_064")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial8 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial8)

ggplot(O2.all.trial8, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial8<- mutate(O2.all.trial8, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial8<- mutate(O2.all.trial8, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial8)

# plot whole body MO2
ggplot(O2.all.trial8, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial8, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial8 <- filter(O2.all.trial8, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial8)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial8[order(O2.all.trial8$fishID,O2.all.trial8$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial8 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial8)
```

### June 30 rd 3 t9
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_6_30_21_round3_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_065","ws_066","ws_067","ws_068","ws_069","ws_070","ws_071","ws_072")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_065")
ch.2.meas <- subset(RMR.trial, fishID == "ws_066")
ch.3.meas <- subset(RMR.trial, fishID == "ws_067")
ch.4.meas <- subset(RMR.trial, fishID == "ws_068")
ch.5.meas <- subset(RMR.trial, fishID == "ws_069")
ch.6.meas <- subset(RMR.trial, fishID == "ws_070")
ch.7.meas <- subset(RMR.trial, fishID == "ws_071")
ch.8.meas <- subset(RMR.trial, fishID == "ws_072")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_065")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_066")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_067")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_068")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_069")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_070")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_071")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_072")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial9 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial9)

ggplot(O2.all.trial9, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial9<- mutate(O2.all.trial9, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial9<- mutate(O2.all.trial9, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial9)

# plot whole body MO2
ggplot(O2.all.trial9, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial9, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial9 <- filter(O2.all.trial9, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial9)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial9[order(O2.all.trial9$fishID,O2.all.trial9$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial9 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial9)
```

### July 1 rd 1 t10
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_7_1_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_073","ws_074","ws_075","ws_076","ws_077","ws_078","ws_079","ws_080")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_073")
ch.2.meas <- subset(RMR.trial, fishID == "ws_074")
ch.3.meas <- subset(RMR.trial, fishID == "ws_075")
ch.4.meas <- subset(RMR.trial, fishID == "ws_076")
ch.5.meas <- subset(RMR.trial, fishID == "ws_077")
ch.6.meas <- subset(RMR.trial, fishID == "ws_078")
ch.7.meas <- subset(RMR.trial, fishID == "ws_079")
ch.8.meas <- subset(RMR.trial, fishID == "ws_080")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_073")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_074")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_075")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_076")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_077")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_078")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_079")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_080")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial10 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial10)

ggplot(O2.all.trial10, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial10<- mutate(O2.all.trial10, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial10<- mutate(O2.all.trial10, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial10)

# plot whole body MO2
ggplot(O2.all.trial10, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial10, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial9 <- filter(O2.all.trial9, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial10)

###################

# Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial10[order(O2.all.trial10$fishID,O2.all.trial10$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial10 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial10)
```

### July 1 rd 2 t11
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_7_1_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_081","ws_082","ws_083","ws_084","ws_085","ws_086","ws_087","ws_088")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_081")
ch.2.meas <- subset(RMR.trial, fishID == "ws_082")
ch.3.meas <- subset(RMR.trial, fishID == "ws_083")
ch.4.meas <- subset(RMR.trial, fishID == "ws_084")
ch.5.meas <- subset(RMR.trial, fishID == "ws_085")
ch.6.meas <- subset(RMR.trial, fishID == "ws_086")
ch.7.meas <- subset(RMR.trial, fishID == "ws_087")
ch.8.meas <- subset(RMR.trial, fishID == "ws_088")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_081")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_082")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_083")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_084")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_085")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_086")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_087")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_088")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial11 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial11)

ggplot(O2.all.trial11, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial11<- mutate(O2.all.trial11, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial11<- mutate(O2.all.trial11, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial11)

# plot whole body MO2
ggplot(O2.all.trial11, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial11, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial9 <- filter(O2.all.trial9, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial11)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial11[order(O2.all.trial11$fishID,O2.all.trial11$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial11 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial11)

```

### July 1 rd 3 t12
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_7_1_21_round3_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_089","ws_090","ws_091","ws_092","ws_093","ws_094","ws_095","ws_096")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_089")
ch.2.meas <- subset(RMR.trial, fishID == "ws_090")
ch.3.meas <- subset(RMR.trial, fishID == "ws_091")
ch.4.meas <- subset(RMR.trial, fishID == "ws_092")
ch.5.meas <- subset(RMR.trial, fishID == "ws_093")
ch.6.meas <- subset(RMR.trial, fishID == "ws_094")
ch.7.meas <- subset(RMR.trial, fishID == "ws_095")
ch.8.meas <- subset(RMR.trial, fishID == "ws_096")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_089")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_090")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_091")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_092")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_093")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_094")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_095")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_096")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial12 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial12)

ggplot(O2.all.trial12, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial12<- mutate(O2.all.trial12, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial12<- mutate(O2.all.trial12, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial12)

# plot whole body MO2
ggplot(O2.all.trial12, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial12, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial9 <- filter(O2.all.trial9, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial12)

###################

# Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial12[order(O2.all.trial12$fishID,O2.all.trial12$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial12 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial12)

```

### July 2 rd 1 t13
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_7_2_21_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_097","ws_098","ws_099","ws_100","ws_101","ws_102","ws_103","ws_104")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_097")
ch.2.meas <- subset(RMR.trial, fishID == "ws_098")
ch.3.meas <- subset(RMR.trial, fishID == "ws_099")
ch.4.meas <- subset(RMR.trial, fishID == "ws_100")
ch.5.meas <- subset(RMR.trial, fishID == "ws_101")
ch.6.meas <- subset(RMR.trial, fishID == "ws_102")
ch.7.meas <- subset(RMR.trial, fishID == "ws_103")
ch.8.meas <- subset(RMR.trial, fishID == "ws_104")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_097")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_098")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_099")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_100")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_101")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_102")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_103")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_104")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial13 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial13)

ggplot(O2.all.trial13, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial13<- mutate(O2.all.trial13, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial13<- mutate(O2.all.trial13, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial13)

# plot whole body MO2
ggplot(O2.all.trial13, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial13, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial9 <- filter(O2.all.trial9, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial13)

###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial13[order(O2.all.trial13$fishID,O2.all.trial13$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial13 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial13)
```

### July 2 rd 2 t14
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_7_2_21_round2_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_105","ws_106","ws_107","ws_108","ws_109","ws_110","ws_111","ws_112")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_105")
ch.2.meas <- subset(RMR.trial, fishID == "ws_106")
ch.3.meas <- subset(RMR.trial, fishID == "ws_107")
ch.4.meas <- subset(RMR.trial, fishID == "ws_108")
ch.5.meas <- subset(RMR.trial, fishID == "ws_109")
ch.6.meas <- subset(RMR.trial, fishID == "ws_110")
ch.7.meas <- subset(RMR.trial, fishID == "ws_111")
ch.8.meas <- subset(RMR.trial, fishID == "ws_112")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_105")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_106")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_107")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_108")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_109")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_110")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_111")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_112")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial14 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial14)

ggplot(O2.all.trial14, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial14<- mutate(O2.all.trial14, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial14<- mutate(O2.all.trial14, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial14)

# plot whole body MO2
ggplot(O2.all.trial14, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial14, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial9 <- filter(O2.all.trial9, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial14)

###################

# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial14[order(O2.all.trial14$fishID,O2.all.trial14$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial14 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial14)

```

### July 2 rd 3 t15
```{r}
#setwd("C:/Users/Vanessa/Documents/R/2021_pesticides")
setwd("/Volumes/GoogleDrive/My Drive/2020 GS Multiple Stressors/2021Expts/Expt Docs - Range Test 2021 WS Fipronil/Metabolism_WSfip_fromVanessaLo/rawdata")

RMR_raw <- readclean("WS_7_2_21_round3_raw.txt")

# Calculate average trial temp
avgTemp <- mean(RMR_raw$Temp)
avgTemp

# Creates a new column, Time in minutes from the start of the file
RMR_raw$Time.m <- sapply(seq_along(RMR_raw$DateTime), function(i) as.numeric(difftime(RMR_raw$DateTime[i], RMR_raw$DateTime[1], units='mins')))
head(RMR_raw)
ggplot(RMR_raw, aes(DateTime,Temp))+
    geom_point()

# grep finds all of the data in RMR$Phase that contains the letter M. i.e. this corresponds to measurement periods
RMR <- RMR_raw[grep("M", RMR_raw$Phase), ]
head(RMR)

# Phases have extra spaces, so this code removes those i.e. "M1  " -> "M1"
RMR$Phase <- gsub(" ", "", RMR$Phase, fixed = TRUE)
# test it..
unique(RMR$Phase)

# Pulls out first value of each phase for graphing later, if you choose to graph by phase
Phase.start <- ddply(RMR, "Phase", head, 1)
Phase.start <- Phase.start[,1:2]

#Changing the column names of the channels to the appropriate fishID/bg bacteria chamber
Name.vec <- c("ws_113","ws_114","ws_115","ws_116","ws_117","ws_118","ws_119","ws_120")
names(RMR)[6:13] <- Name.vec

#Reshape the data so all O2sat values are in a single column
RMR.2 <- melt(RMR, measure = Name.vec)
head(RMR.2)
str(RMR.2)

# Rename the columns. 
names(RMR.2) <-c("DateTime","Phase","BaroP","Salinity","Temp","Time.m","fishID","O2.sat")
head(RMR.2)

RMR.2$sat100.mgO2perL <- O2.saturation(4,RMR.2$Temp,RMR.2$BaroP, 100)[[6]]
RMR.2$sat100.mgO2permL <- RMR.2$sat100.mgO2perL/1000

# Merge raw data and fish data
RMR.trial <-merge(RMR.2, fish.data, by=c("fishID"), all.x=TRUE)

# Calculate total mgO2 by multiplying mgO2/mL and mL of chamber - fish
RMR.trial$sat100.mgO2 <- ((RMR.trial$volume.ml - RMR.trial$weight.g)*RMR.trial$sat100.mgO2permL)

# Calculate mgO2 at any point in time by multiplying %O2 saturation/100 and mgO2 at 100% sat
RMR.trial$mgO2 <- RMR.trial$O2.sat/100*RMR.trial$sat100.mgO2

ggplot(RMR.trial, aes(x = Time.m, y = mgO2, color = fishID))+
  geom_point()

# Separating out individual fish for graphing/analysis
ch.1.meas <- subset(RMR.trial, fishID == "ws_113")
ch.2.meas <- subset(RMR.trial, fishID == "ws_114")
ch.3.meas <- subset(RMR.trial, fishID == "ws_115")
ch.4.meas <- subset(RMR.trial, fishID == "ws_116")
ch.5.meas <- subset(RMR.trial, fishID == "ws_117")
ch.6.meas <- subset(RMR.trial, fishID == "ws_118")
ch.7.meas <- subset(RMR.trial, fishID == "ws_119")
ch.8.meas <- subset(RMR.trial, fishID == "ws_120")

p=ggplot(data=ch.7.meas, aes(x=Time.m, y=as.numeric(O2.sat)))
p+geom_line(aes(color=Phase))+theme_bw()+facet_wrap(~Phase, ncol=8)+
  scale_y_continuous(name="% air saturation")+
  scale_x_continuous(name="Time (min)")

#Calculate slopes of lines for each fish, converting slope from minutes to hours
O2slopel1 <- dlply(ch.1.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope1 <- ldply(O2slopel1, function(d) coef(d))
names(O2slope1) <- c("Phase", "Intercept","Slope")
O2slope1<- mutate(O2slope1, fishID = "ws_113")
O2slope1<-ddply(O2slope1, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel2 <- dlply(ch.2.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope2 <- ldply(O2slopel2, function(d) coef(d))
names(O2slope2) <- c("Phase", "Intercept","Slope")
O2slope2 <- mutate(O2slope2, fishID = "ws_114")
O2slope2<-ddply(O2slope2, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel3 <- dlply(ch.3.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope3 <- ldply(O2slopel3, function(d) coef(d))
names(O2slope3) <- c("Phase", "Intercept","Slope")
O2slope3 <- mutate(O2slope3, fishID = "ws_115")
O2slope3<-ddply(O2slope3, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel4 <- dlply(ch.4.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope4 <- ldply(O2slopel4, function(d) coef(d))
names(O2slope4) <- c("Phase", "Intercept","Slope")
O2slope4 <- mutate(O2slope4, fishID = "ws_116")
O2slope4<-ddply(O2slope4, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel5 <- dlply(ch.5.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope5 <- ldply(O2slopel5, function(d) coef(d))
names(O2slope5) <- c("Phase", "Intercept","Slope")
O2slope5 <- mutate(O2slope5, fishID = "ws_117")
O2slope5<-ddply(O2slope5, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel6 <- dlply(ch.6.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope6 <- ldply(O2slopel6, function(d) coef(d))
names(O2slope6) <- c("Phase", "Intercept","Slope")
O2slope6 <- mutate(O2slope6, fishID = "ws_118")
O2slope6<-ddply(O2slope6, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel7 <- dlply(ch.7.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope7 <- ldply(O2slopel7, function(d) coef(d))
names(O2slope7) <- c("Phase", "Intercept","Slope")
O2slope7 <- mutate(O2slope7, fishID = "ws_119")
O2slope7<-ddply(O2slope7, .(Phase), mutate, Slope.hour=Slope*60)

O2slopel8 <- dlply(ch.8.meas, .(Phase), function(d) lm(mgO2 ~ Time.m, data = d))
O2slope8 <- ldply(O2slopel8, function(d) coef(d))
names(O2slope8) <- c("Phase", "Intercept","Slope")
O2slope8 <- mutate(O2slope8, fishID = "ws_120")
O2slope8<-ddply(O2slope8, .(Phase), mutate, Slope.hour=Slope*60)

# Calculating slope fits
O2.r2.1 <- dlply(ch.1.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit1<-ldply(O2.r2.1, function(d) d$r.squared)
slopefit1
names(slopefit1) <-c("Phase","r2")

O2.r2.2 <- dlply(ch.2.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit2<-ldply(O2.r2.2, function(d) d$r.squared)
slopefit2
names(slopefit2) <-c("Phase","r2")

O2.r2.3 <- dlply(ch.3.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit3<-ldply(O2.r2.3, function(d) d$r.squared)
slopefit3
names(slopefit3) <-c("Phase","r2")

O2.r2.4 <- dlply(ch.4.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit4<-ldply(O2.r2.4, function(d) d$r.squared)
slopefit4
names(slopefit4) <-c("Phase","r2")

O2.r2.5 <- dlply(ch.5.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit5<-ldply(O2.r2.5, function(d) d$r.squared)
slopefit5
names(slopefit5) <-c("Phase","r2")

O2.r2.6 <- dlply(ch.6.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit6<-ldply(O2.r2.6, function(d) d$r.squared)
slopefit6
names(slopefit6) <-c("Phase","r2")

O2.r2.7 <- dlply(ch.7.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit7<-ldply(O2.r2.7, function(d) d$r.squared)
slopefit7
names(slopefit7) <-c("Phase","r2")

O2.r2.8 <- dlply(ch.8.meas, .(Phase), function(d) summary(lm(mgO2 ~ Time.m, data = d))) 
slopefit8<-ldply(O2.r2.8, function(d) d$r.squared)
slopefit8
names(slopefit8) <-c("Phase","r2")

# merge together slope and r2
O2slope.r2.1<-merge(O2slope1, slopefit1, by=c("Phase"))
O2slope.r2.1<- O2slope.r2.1[mixedorder(O2slope.r2.1$Phase),]
O2slope.r2.1

O2slope.r2.2<-merge(O2slope2, slopefit2, by=c("Phase"))
O2slope.r2.2<- O2slope.r2.2[mixedorder(O2slope.r2.2$Phase),]
O2slope.r2.2

O2slope.r2.3<-merge(O2slope3, slopefit3, by=c("Phase"))
O2slope.r2.3<- O2slope.r2.3[mixedorder(O2slope.r2.3$Phase),]
O2slope.r2.3

O2slope.r2.4<-merge(O2slope4, slopefit4, by=c("Phase"))
O2slope.r2.4<- O2slope.r2.4[mixedorder(O2slope.r2.4$Phase),]
O2slope.r2.4

O2slope.r2.5<-merge(O2slope5, slopefit5, by=c("Phase"))
O2slope.r2.5<- O2slope.r2.5[mixedorder(O2slope.r2.5$Phase),]
O2slope.r2.5

O2slope.r2.6<-merge(O2slope6, slopefit6, by=c("Phase"))
O2slope.r2.6<- O2slope.r2.6[mixedorder(O2slope.r2.6$Phase),]
O2slope.r2.6

O2slope.r2.7<-merge(O2slope7, slopefit7, by=c("Phase"))
O2slope.r2.7<- O2slope.r2.7[mixedorder(O2slope.r2.7$Phase),]
O2slope.r2.7

O2slope.r2.8<-merge(O2slope8, slopefit8, by=c("Phase"))
O2slope.r2.8<- O2slope.r2.8[mixedorder(O2slope.r2.8$Phase),]
O2slope.r2.8

# bind all slope and r2 dataframes. Sorts phases properly
slopes.r2.all <- rbind(O2slope.r2.1,O2slope.r2.2,O2slope.r2.3,O2slope.r2.4,O2slope.r2.5,O2slope.r2.6,O2slope.r2.7,O2slope.r2.8)
slopes.r2.all$fishID <- as.factor(slopes.r2.all$fishID)
slopes.r2.all <- merge(slopes.r2.all, Phase.start, by=c("Phase"))
phase.sort <- unique(mixedsort(slopes.r2.all$Phase))
slopes.r2.all$Phase <- factor(slopes.r2.all$Phase, levels = phase.sort)


str(slopes.r2.all)

# add back in all the fish related data
O2.all.trial15 <- merge(slopes.r2.all, RMR.trial)
str(O2.all.trial15)

ggplot(O2.all.trial15, aes(x=DateTime, y=Slope))+
  geom_point(aes(color=fishID))+
  theme_bw()

# Slope.hour is mgO2/h as calculated from the decline of mgO2 in the chamber over time in min, then converted to h. Value is negative because it's consumption of O2.
# multiply by -1 to have a positive O2 rate, units mgO2/h
O2.all.trial15<- mutate(O2.all.trial15, mgO2hpos = Slope.hour*-1)

# calculate mass specific rates
O2.all.trial15<- mutate(O2.all.trial15, mass.specific.mgO2ghr = mgO2hpos/weight.g)
str(O2.all.trial15)

# plot whole body MO2
ggplot(O2.all.trial15, aes(x=Phase, y=mgO2hpos))+
  geom_point(aes(color=fishID))+
  theme_bw()
# plot mass specific MO2
ggplot(O2.all.trial15, aes(x=Phase, y=mass.specific.mgO2ghr))+
  geom_point(aes(color=fishID))+
  theme_bw()

# remove bg bact values
O2.all.trial9 <- filter(O2.all.trial9, mass.specific.mgO2ghr > 0.1)

O2.all <- rbind(O2.all,O2.all.trial15)
```

```{r}
###################
# 
# # Order data to find lowest 3 MO2 values
# sort.O2<- O2.all.trial15[order(O2.all.trial15$fishID,O2.all.trial15$mass.specific.mgO2ghr),]
# lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
# 
# # Then reduce the list into a data frame with the lowest 3 MO2 values for each fish
# low3MO2_trial15 <- Reduce(rbind, lowest3)
# low3MO2.ws <- rbind(low3MO2.ws,low3MO2_trial15)
# 
# filter r2, calculate lowMO2
O2.all <- filter(O2.all, r2 > 0.98)
sort.O2 <- O2.all[order(O2.all$fishID,O2.all$mass.specific.mgO2ghr),]
lowest3 <- by(sort.O2, sort.O2["fishID"], head, n=3)
low3MO2.ws <- Reduce(rbind, lowest3)

```




### WS data plots

```{r}

names(low3MO2.ws)
ggplot(low3MO2.ws, aes(x= Phase, y = mass.specific.mgO2ghr, color = fishID))+
  geom_point()+
  facet_wrap(~treatment)

mean.O2 <- aggregate(low3MO2.ws$mass.specific.mgO2ghr, by=list(low3MO2.ws$fishID), mean)
names(mean.O2) <- c("fishID","mass.spec.MO2")

O2.ws.final <- merge(mean.O2, fish.data, by = "fishID")
str(O2.ws.final)


ggplot(O2.ws.final, aes(x = treatment, y = mass.spec.MO2))+
  geom_boxplot()+
  ylab("Mass Specific Metabolic Rate")

```


### No mass
```{r}
mean.O2.no.mass <- aggregate(low3MO2.ws$mgO2hpos, by=list(low3MO2.ws$fishID), mean)
names(mean.O2.no.mass) <- c("fishID","ind.MO2")

O2.ws.no.mass <- merge(mean.O2.no.mass, fish.data, by = "fishID")
all.ws <- merge(O2.ws.final, O2.ws.no.mass, by = "fishID")

ggplot(O2.ws.no.mass, aes(x = treatment, y = ind.MO2))+
  geom_boxplot()+
  ylab("Whole Body Metabolic Rate (mgO2/h)")+
  theme_bw()

my.formula <- y ~ x
ggplot(O2.ws.no.mass, aes(x = weight.g, y = ind.MO2, color = treatment))+
  geom_point()+
  geom_smooth(method = "lm",se = FALSE)+
  scale_y_continuous(trans="log10")+
  scale_x_continuous(trans="log10")+
   ylab("Metabolic Rate (mgO2/h/individual)")+
  ggtitle("WS")+
  geom_smooth(aes(group=treatment), method="lm", linetype = "dashed", size = .5, formula = my.formula) +
  stat_poly_eq(formula = my.formula, aes(label = paste(..eq.label..,..rr.label.., sep = "~~~")), parse = TRUE)+
  theme_bw()

# ws.no.mass <- merge(O2.ws.no.mass, fish.data, by = "fishID")
all.ws <- merge(O2.ws.final, O2.ws.no.mass, by = "fishID")
all.ws$species <- "WS"
all.gs$species <- "GS"
write.csv(all.ws,"2021_final_WS_metabolism.csv")
final.gs.ws<- rbind(all.gs,all.ws)
write.csv(final.gs.ws,"2021_gs_ws_final_metabolism.csv")

ggplot(final.gs.ws, aes(x = treatment, y = ind.MO2))+
  geom_boxplot()+
  facet_wrap(~species)+
  ylab("Whole Body Metabolic Rate (mgO2/h)")+
  theme_bw()

ggplot(final.gs.ws, aes(x = treatment, y = mass.spec.MO2))+
  geom_boxplot()+
  facet_wrap(~species)+
  ylab("Mass Specific Metabolic Rate (mgO2/h)")+
  theme_bw()


  
```

Add rep/day and round1/2/3